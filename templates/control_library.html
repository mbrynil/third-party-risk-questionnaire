{% extends "base.html" %}

{% block title %}Control Library{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
<li class="breadcrumb-item active">Control Library</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="mb-1"><i class="bi bi-shield-lock me-2"></i>Control Library</h3>
        <p class="text-muted mb-0">{{ stats.active }} active controls across {{ stats.domains }} domains — {{ stats.frameworks_covered }} frameworks mapped</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#quickAddForm"><i class="bi bi-lightning me-1"></i>Quick Add</button>
        <a href="/controls/new" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Add Control</a>
    </div>
</div>

{% set message = request.query_params.get('message', '') %}
{% if message %}
<div class="alert alert-{{ request.query_params.get('message_type', 'info') }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{# Quick Add Form (collapsed) #}
<div class="collapse mb-3" id="quickAddForm">
    <div class="card border-primary">
        <div class="card-body py-3">
            <form method="post" action="/controls/quick-add" class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label form-label-sm mb-1">Ref <span class="text-danger">*</span></label>
                    <input type="text" name="control_ref" class="form-control form-control-sm" required placeholder="CTL-XX-001">
                </div>
                <div class="col-md-3">
                    <label class="form-label form-label-sm mb-1">Title <span class="text-danger">*</span></label>
                    <input type="text" name="title" class="form-control form-control-sm" required placeholder="Control title">
                </div>
                <div class="col-md-3">
                    <label class="form-label form-label-sm mb-1">Domain <span class="text-danger">*</span></label>
                    <select name="domain" class="form-select form-select-sm" required>
                        {% for d in domains %}
                        <option value="{{ d }}">{{ d }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label form-label-sm mb-1">Criticality</label>
                    <select name="criticality" class="form-select form-select-sm">
                        {% for c in criticalities %}
                        <option value="{{ c }}" {% if c == 'HIGH' %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-sm btn-primary w-100"><i class="bi bi-plus-lg me-1"></i>Create</button>
                </div>
            </form>
            <small class="text-muted mt-1 d-block">Defaults: Preventive, Manual, Annual. Edit after creation for full details.</small>
        </div>
    </div>
</div>

{# Filter Bar #}
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label form-label-sm mb-1">Domain</label>
                <select name="domain" class="form-select form-select-sm">
                    <option value="">All Domains</option>
                    {% for d in domains %}
                    <option value="{{ d }}" {% if f_domain == d %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label form-label-sm mb-1">Framework</label>
                <select name="framework" class="form-select form-select-sm">
                    <option value="">All Frameworks</option>
                    {% for key, label in frameworks %}
                    <option value="{{ key }}" {% if f_framework == key %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label form-label-sm mb-1">Type</label>
                <select name="control_type" class="form-select form-select-sm">
                    <option value="">All Types</option>
                    {% for t in control_types %}
                    <option value="{{ t }}" {% if f_control_type == t %}selected{% endif %}>{{ control_type_labels[t] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label form-label-sm mb-1">Criticality</label>
                <select name="criticality" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for c in criticalities %}
                    <option value="{{ c }}" {% if f_criticality == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex gap-1">
                <button type="submit" class="btn btn-sm btn-outline-primary flex-grow-1">Filter</button>
                <a href="/controls" class="btn btn-sm btn-outline-secondary">Clear</a>
            </div>
        </form>
    </div>
</div>

{# Instant Search #}
<div class="mb-3">
    <input type="text" id="controlSearch" class="form-control" placeholder="Search controls by ref, title, objective, or owner...">
</div>

{% if grouped %}
{% for domain, controls in grouped.items() %}
<div class="card mb-3 domain-section">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-folder me-1"></i>{{ domain }}</h6>
        <span class="badge bg-secondary domain-count">{{ controls|length }}</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th style="width:90px;">Ref</th>
                    <th>Control</th>
                    <th>Objective</th>
                    <th style="width:100px;">Owner</th>
                    <th style="width:100px;">Last Tested</th>
                    <th style="width:90px;">Criticality</th>
                    <th>Frameworks</th>
                    <th class="text-end" style="width:80px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for ctrl in controls %}
                <tr class="control-row" data-text="{{ ctrl.control_ref|lower }} {{ ctrl.title|lower }} {{ (ctrl.description or '')|lower }} {{ (ctrl.owner_role or '')|lower }}">
                    <td><a href="/controls/{{ ctrl.id }}" class="text-decoration-none fw-semibold">{{ ctrl.control_ref }}</a></td>
                    <td><a href="/controls/{{ ctrl.id }}" class="text-decoration-none">{{ ctrl.title }}</a></td>
                    <td><small class="text-muted">{{ (ctrl.description or '')[:80] }}{% if ctrl.description and ctrl.description|length > 80 %}...{% endif %}</small></td>
                    <td><small class="text-muted">{{ ctrl.owner_role or '—' }}</small></td>
                    <td>
                        {% set lt = last_tested_map.get(ctrl.id) %}
                        {% if lt %}
                        <small class="text-muted">{{ lt.strftime('%Y-%m-%d') }}</small>
                        {% else %}
                        <small class="text-muted fst-italic">Never</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge bg-{% if ctrl.criticality == 'CRITICAL' %}danger{% elif ctrl.criticality == 'HIGH' %}warning text-dark{% elif ctrl.criticality == 'MEDIUM' %}info{% else %}secondary{% endif %}">{{ ctrl.criticality }}</span>
                    </td>
                    <td>
                        {% for m in ctrl.framework_mappings %}
                        <span class="badge bg-light text-dark border" style="font-size:0.7rem;">{{ framework_display.get(m.framework, m.framework) }}: {{ m.reference }}</span>
                        {% endfor %}
                    </td>
                    <td class="text-end">
                        <div class="d-flex gap-1 justify-content-end">
                            <a href="/controls/{{ ctrl.id }}/edit" class="btn btn-sm btn-outline-secondary" title="Edit"><i class="bi bi-pencil"></i></a>
                            <form method="post" action="/controls/{{ ctrl.id }}/toggle" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-{% if ctrl.is_active %}warning{% else %}success{% endif %}" title="{{ 'Deactivate' if ctrl.is_active else 'Activate' }}">
                                    <i class="bi bi-{% if ctrl.is_active %}pause-circle{% else %}play-circle{% endif %}"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endfor %}
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-shield-lock" style="font-size:3rem;color:#d1d5db;"></i>
        <h5 class="mt-3 text-muted">No controls found</h5>
        <p class="text-muted">Add your first control to build the library.</p>
        <a href="/controls/new" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Add Control</a>
    </div>
</div>
{% endif %}

<script>
document.getElementById('controlSearch').addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    const rows = document.querySelectorAll('.control-row');
    const sections = document.querySelectorAll('.domain-section');

    rows.forEach(function(row) {
        const text = row.getAttribute('data-text');
        row.style.display = (!query || text.indexOf(query) !== -1) ? '' : 'none';
    });

    sections.forEach(function(section) {
        const visibleRows = section.querySelectorAll('.control-row[style=""], .control-row:not([style])');
        let hasVisible = false;
        section.querySelectorAll('.control-row').forEach(function(r) {
            if (r.style.display !== 'none') hasVisible = true;
        });
        section.style.display = hasVisible ? '' : 'none';

        // Update count badge
        let count = 0;
        section.querySelectorAll('.control-row').forEach(function(r) {
            if (r.style.display !== 'none') count++;
        });
        const badge = section.querySelector('.domain-count');
        if (badge) badge.textContent = count;
    });
});
</script>
{% endblock %}
