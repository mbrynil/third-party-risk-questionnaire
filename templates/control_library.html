{% extends "base.html" %}

{% block title %}Control Library{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
<li class="breadcrumb-item active">Control Library</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="mb-1"><i class="bi bi-shield-lock me-2"></i>Control Library</h3>
        <p class="text-muted mb-0">{{ stats.active }} active controls across {{ stats.domains }} domains — {{ stats.frameworks_covered }} frameworks mapped</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#quickAddForm"><i class="bi bi-lightning me-1"></i>Quick Add</button>
        <a href="/controls/new" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Add Control</a>
    </div>
</div>

{% set message = request.query_params.get('message', '') %}
{% if message %}
<div class="alert alert-{{ request.query_params.get('message_type', 'info') }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{# Quick Add Form (collapsed) #}
<div class="collapse mb-3" id="quickAddForm">
    <div class="card border-primary">
        <div class="card-body py-3">
            <form method="post" action="/controls/quick-add" class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label form-label-sm mb-1">Ref <span class="text-danger">*</span></label>
                    <input type="text" name="control_ref" class="form-control form-control-sm" required placeholder="CTL-XX-001">
                </div>
                <div class="col-md-3">
                    <label class="form-label form-label-sm mb-1">Title <span class="text-danger">*</span></label>
                    <input type="text" name="title" class="form-control form-control-sm" required placeholder="Control title">
                </div>
                <div class="col-md-3">
                    <label class="form-label form-label-sm mb-1">Domain <span class="text-danger">*</span></label>
                    <select name="domain" class="form-select form-select-sm" required>
                        {% for d in domains %}
                        <option value="{{ d }}">{{ d }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label form-label-sm mb-1">Criticality</label>
                    <select name="criticality" class="form-select form-select-sm">
                        {% for c in criticalities %}
                        <option value="{{ c }}" {% if c == 'HIGH' %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-sm btn-primary w-100"><i class="bi bi-plus-lg me-1"></i>Create</button>
                </div>
            </form>
            <small class="text-muted mt-1 d-block">Defaults: Preventive, Manual, Annual. Edit after creation for full details.</small>
        </div>
    </div>
</div>

{# Filter Bar #}
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-md-2">
                <label class="form-label form-label-sm mb-1">Domain</label>
                <select name="domain" class="form-select form-select-sm">
                    <option value="">All Domains</option>
                    {% for d in domains %}
                    <option value="{{ d }}" {% if f_domain == d %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label form-label-sm mb-1">Framework</label>
                <select name="framework" class="form-select form-select-sm">
                    <option value="">All Frameworks</option>
                    {% for key, label in frameworks %}
                    <option value="{{ key }}" {% if f_framework == key %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label class="form-label form-label-sm mb-1">Type</label>
                <select name="control_type" class="form-select form-select-sm">
                    <option value="">All Types</option>
                    {% for t in control_types %}
                    <option value="{{ t }}" {% if f_control_type == t %}selected{% endif %}>{{ control_type_labels[t] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label class="form-label form-label-sm mb-1">Criticality</label>
                <select name="criticality" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for c in criticalities %}
                    <option value="{{ c }}" {% if f_criticality == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label class="form-label form-label-sm mb-1">Owner</label>
                <select name="owner" class="form-select form-select-sm">
                    <option value="">All Owners</option>
                    {% for u in users %}
                    <option value="{{ u.id }}" {% if f_owner == u.id|string %}selected{% endif %}>{{ u.display_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label class="form-label form-label-sm mb-1">Impl. Status</label>
                <select name="impl_status" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for s in impl_statuses %}
                    <option value="{{ s }}" {% if f_impl_status == s %}selected{% endif %}>{{ impl_status_labels[s] }}</option>
                    {% endfor %}
                    <option value="NOT_TRACKED" {% if f_impl_status == 'NOT_TRACKED' %}selected{% endif %}>Not Tracked</option>
                </select>
            </div>
            <div class="col">
                <label class="form-label form-label-sm mb-1">Health</label>
                <select name="health" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="healthy" {% if f_health == 'healthy' %}selected{% endif %}>Healthy</option>
                    <option value="adequate" {% if f_health == 'adequate' %}selected{% endif %}>Adequate</option>
                    <option value="at_risk" {% if f_health == 'at_risk' %}selected{% endif %}>At Risk</option>
                    <option value="critical" {% if f_health == 'critical' %}selected{% endif %}>Critical</option>
                </select>
            </div>
            <div class="col d-flex gap-1">
                <button type="submit" class="btn btn-sm btn-outline-primary flex-grow-1">Filter</button>
                <a href="/controls" class="btn btn-sm btn-outline-secondary">Clear</a>
            </div>
        </form>
    </div>
</div>

{# Instant Search #}
<div class="mb-3">
    <input type="text" id="controlSearch" class="form-control" placeholder="Search controls by ref, title, objective, or owner...">
</div>

{# Bulk Implement Floating Bar #}
<div id="bulkBar" class="card border-primary mb-3" style="display:none;position:sticky;top:60px;z-index:100;">
    <div class="card-body py-2 d-flex align-items-center gap-3">
        <span class="fw-semibold"><span id="selectedCount">0</span> selected</span>
        <form method="post" action="/controls/bulk-implement" id="bulkForm">
            <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-gear me-1"></i>Implement Selected</button>
        </form>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">Clear</button>
    </div>
</div>

{% if grouped %}
{% for domain, controls in grouped.items() %}
<div class="card mb-3 domain-section">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-folder me-1"></i>{{ domain }}</h6>
        <span class="badge bg-secondary domain-count">{{ controls|length }}</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th style="width:36px;"><input type="checkbox" class="form-check-input select-all-domain" onchange="toggleDomainAll(this)"></th>
                    <th style="width:90px;">Ref</th>
                    <th>Control</th>
                    <th>Objective</th>
                    <th style="width:100px;">Owner</th>
                    <th style="width:80px;">Impl.</th>
                    <th style="width:80px;">Health</th>
                    <th style="width:100px;">Last Tested</th>
                    <th style="width:90px;">Criticality</th>
                    <th>Frameworks</th>
                    <th class="text-end" style="width:80px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for ctrl in controls %}
                <tr class="control-row" data-text="{{ ctrl.control_ref|lower }} {{ ctrl.title|lower }} {{ (ctrl.objective or '')|lower }} {{ (ctrl.owner.display_name|lower if ctrl.owner else (ctrl.owner_role or '')|lower) }}">
                    <td><input type="checkbox" class="form-check-input ctrl-checkbox" value="{{ ctrl.id }}" onchange="updateBulkBar()"></td>
                    <td><a href="/controls/{{ ctrl.id }}" class="text-decoration-none fw-semibold">{{ ctrl.control_ref }}</a></td>
                    <td><a href="/controls/{{ ctrl.id }}" class="text-decoration-none">{{ ctrl.title }}</a></td>
                    <td><small class="text-muted">{{ (ctrl.objective or '')[:80] }}{% if ctrl.objective and ctrl.objective|length > 80 %}...{% endif %}</small></td>
                    <td><small class="text-muted">{{ ctrl.owner.display_name if ctrl.owner else (ctrl.owner_role or '—') }}</small></td>
                    <td>
                        {% set ist = impl_status_map.get(ctrl.id) %}
                        {% if ist %}
                        <span class="badge" style="background-color:{{ impl_status_colors.get(ist, '#6c757d') }};font-size:0.65rem;">{{ impl_status_labels.get(ist, ist) }}</span>
                        {% else %}
                        <small class="text-muted fst-italic">—</small>
                        {% endif %}
                    </td>
                    <td>
                        {% set h = health_map.get(ctrl.id) %}
                        {% if h %}
                        <span class="badge" style="background-color:{{ h.health_color }};font-size:0.65rem;">{{ h.score }}</span>
                        {% else %}
                        <small class="text-muted">—</small>
                        {% endif %}
                    </td>
                    <td>
                        {% set lt = last_tested_map.get(ctrl.id) %}
                        {% if lt %}
                        <small class="text-muted">{{ lt.strftime('%Y-%m-%d') }}</small>
                        {% else %}
                        <small class="text-muted fst-italic">Never</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge bg-{% if ctrl.criticality == 'CRITICAL' %}danger{% elif ctrl.criticality == 'HIGH' %}warning text-dark{% elif ctrl.criticality == 'MEDIUM' %}info{% else %}secondary{% endif %}">{{ ctrl.criticality }}</span>
                    </td>
                    <td>
                        {% for m in ctrl.framework_mappings %}
                        <span class="badge bg-light text-dark border" style="font-size:0.7rem;">{{ framework_display.get(m.framework, m.framework) }}: {{ m.reference }}</span>
                        {% endfor %}
                    </td>
                    <td class="text-end">
                        <div class="d-flex gap-1 justify-content-end">
                            <a href="/controls/{{ ctrl.id }}/edit" class="btn btn-sm btn-outline-secondary" title="Edit"><i class="bi bi-pencil"></i></a>
                            <form method="post" action="/controls/{{ ctrl.id }}/toggle" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-{% if ctrl.is_active %}warning{% else %}success{% endif %}" title="{{ 'Deactivate' if ctrl.is_active else 'Activate' }}">
                                    <i class="bi bi-{% if ctrl.is_active %}pause-circle{% else %}play-circle{% endif %}"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endfor %}
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-shield-lock" style="font-size:3rem;color:#d1d5db;"></i>
        <h5 class="mt-3 text-muted">No controls found</h5>
        <p class="text-muted">Add your first control to build the library.</p>
        <a href="/controls/new" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Add Control</a>
    </div>
</div>
{% endif %}

<script>
// Instant search
document.getElementById('controlSearch').addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    const rows = document.querySelectorAll('.control-row');
    const sections = document.querySelectorAll('.domain-section');

    rows.forEach(function(row) {
        const text = row.getAttribute('data-text');
        row.style.display = (!query || text.indexOf(query) !== -1) ? '' : 'none';
    });

    sections.forEach(function(section) {
        let hasVisible = false;
        let count = 0;
        section.querySelectorAll('.control-row').forEach(function(r) {
            if (r.style.display !== 'none') { hasVisible = true; count++; }
        });
        section.style.display = hasVisible ? '' : 'none';
        const badge = section.querySelector('.domain-count');
        if (badge) badge.textContent = count;
    });
});

// Bulk selection
function updateBulkBar() {
    var checked = document.querySelectorAll('.ctrl-checkbox:checked');
    var bar = document.getElementById('bulkBar');
    var count = document.getElementById('selectedCount');
    if (checked.length > 0) {
        bar.style.display = '';
        count.textContent = checked.length;
        // Sync hidden inputs
        var form = document.getElementById('bulkForm');
        form.querySelectorAll('input[name="control_ids"]').forEach(function(el) { el.remove(); });
        checked.forEach(function(cb) {
            var inp = document.createElement('input');
            inp.type = 'hidden';
            inp.name = 'control_ids';
            inp.value = cb.value;
            form.appendChild(inp);
        });
    } else {
        bar.style.display = 'none';
    }
}

function toggleDomainAll(el) {
    var tbody = el.closest('table').querySelector('tbody');
    tbody.querySelectorAll('.ctrl-checkbox').forEach(function(cb) {
        var row = cb.closest('tr');
        if (row.style.display !== 'none') cb.checked = el.checked;
    });
    updateBulkBar();
}

function clearSelection() {
    document.querySelectorAll('.ctrl-checkbox').forEach(function(cb) { cb.checked = false; });
    document.querySelectorAll('.select-all-domain').forEach(function(cb) { cb.checked = false; });
    updateBulkBar();
}
</script>
{% endblock %}
