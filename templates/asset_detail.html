{% extends "base.html" %}

{% block title %}{{ asset.asset_ref }} — {{ asset.name }}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
<li class="breadcrumb-item"><a href="/assets">Asset Inventory</a></li>
<li class="breadcrumb-item active">{{ asset.asset_ref }}</li>
{% endblock %}

{% block content %}
{# Header #}
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h3 class="mb-1">
            <code class="me-2">{{ asset.asset_ref }}</code>{{ asset.name }}
        </h3>
        <div class="d-flex gap-2 mt-1">
            <span class="badge bg-light text-dark"><i class="bi {{ ASSET_TYPE_ICONS.get(asset.asset_type, 'bi-box') }} me-1"></i>{{ ASSET_TYPE_LABELS.get(asset.asset_type, asset.asset_type) }}</span>
            <span class="badge" style="background:{{ ASSET_STATUS_COLORS.get(asset.status, '#6c757d') }};">{{ ASSET_STATUS_LABELS.get(asset.status, asset.status) }}</span>
            {% if asset.environment %}
            <span class="badge bg-light text-dark">{{ asset.environment }}</span>
            {% endif %}
        </div>
    </div>
    <div class="d-flex gap-2">
        {% if request.state.current_user and request.state.current_user.role != 'viewer' %}
        <a href="/assets/{{ asset.id }}/edit" class="btn btn-outline-primary btn-sm"><i class="bi bi-pencil me-1"></i>Edit</a>
        {% endif %}
        {% if request.state.current_user and request.state.current_user.role == 'admin' %}
        <form method="post" action="/assets/{{ asset.id }}/delete" class="d-inline" onsubmit="return confirm('Delete this asset?');">
            <button type="submit" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash me-1"></i>Delete</button>
        </form>
        {% endif %}
    </div>
</div>

<div class="row">
    {# Main content — left column #}
    <div class="col-lg-8">
        {# Description #}
        {% if asset.description %}
        <div class="card mb-3">
            <div class="card-header"><strong>Description</strong></div>
            <div class="card-body">
                <p style="white-space:pre-wrap;" class="mb-0">{{ asset.description }}</p>
            </div>
        </div>
        {% endif %}

        {# Technical Details #}
        {% if asset.hostname or asset.ip_address or asset.operating_system or asset.version %}
        <div class="card mb-3">
            <div class="card-header"><strong><i class="bi bi-cpu me-1"></i>Technical Details</strong></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="mb-0">
                            <dt>Hostname</dt>
                            <dd>{{ asset.hostname or '—' }}</dd>
                            <dt>IP Address</dt>
                            <dd>{% if asset.ip_address %}<code>{{ asset.ip_address }}</code>{% else %}—{% endif %}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="mb-0">
                            <dt>Operating System</dt>
                            <dd>{{ asset.operating_system or '—' }}</dd>
                            <dt>Version</dt>
                            <dd>{{ asset.version or '—' }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Linked Controls #}
        <div class="card mb-3">
            <div class="card-header"><strong>Linked Controls</strong> <span class="badge bg-secondary">{{ asset.control_mappings|length }}</span></div>
            <div class="card-body">
                {% if asset.control_mappings %}
                <ul class="list-group list-group-flush mb-3">
                    {% for m in asset.control_mappings %}
                    <li class="list-group-item d-flex justify-content-between">
                        <a href="/controls/{{ m.control.id }}">{{ m.control.control_ref }} — {{ m.control.title }}</a>
                        <span class="badge bg-light text-dark">{{ m.control.domain }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% if request.state.current_user and request.state.current_user.role != 'viewer' %}
                <form method="post" action="/assets/{{ asset.id }}/mappings/controls">
                    <label class="form-label small fw-semibold">Select Controls</label>
                    <select name="control_ids" class="form-select form-select-sm" multiple size="5">
                        {% set mapped_ids = asset.control_mappings|map(attribute='control_id')|list %}
                        {% for c in all_controls %}
                        <option value="{{ c.id }}" {{ 'selected' if c.id in mapped_ids }}>{{ c.control_ref }} — {{ c.title }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-sm btn-outline-primary mt-2">Save Control Mappings</button>
                </form>
                {% endif %}
            </div>
        </div>

        {# Comments #}
        {% set comment_entity_type = "asset" %}
        {% set comment_entity_id = asset.id %}
        {% include "partials/comments.html" with context %}
    </div>

    {# Sidebar — right column #}
    <div class="col-lg-4">
        {# Classification #}
        <div class="card mb-3">
            <div class="card-header"><strong><i class="bi bi-shield-lock me-1"></i>Classification</strong></div>
            <div class="card-body small">
                <dl class="mb-0">
                    <dt>Data Classification</dt>
                    <dd>
                        {% if asset.data_classification %}
                        <span class="badge {% if asset.data_classification == 'Restricted' %}bg-danger{% elif asset.data_classification == 'Confidential' %}bg-warning text-dark{% elif asset.data_classification == 'Internal' %}bg-info text-dark{% else %}bg-secondary{% endif %}">{{ asset.data_classification }}</span>
                        {% else %}—{% endif %}
                    </dd>
                    <dt>Business Criticality</dt>
                    <dd>
                        {% if asset.business_criticality %}
                        <span class="badge {% if asset.business_criticality == 'Critical' %}bg-danger{% elif asset.business_criticality == 'High' %}bg-warning text-dark{% elif asset.business_criticality == 'Medium' %}bg-info text-dark{% else %}bg-secondary{% endif %}">{{ asset.business_criticality }}</span>
                        {% else %}—{% endif %}
                    </dd>
                    <dt>Environment</dt>
                    <dd>{{ asset.environment or '—' }}</dd>
                </dl>
            </div>
        </div>

        {# Ownership #}
        <div class="card mb-3">
            <div class="card-header"><strong><i class="bi bi-person me-1"></i>Ownership</strong></div>
            <div class="card-body small">
                <dl class="mb-0">
                    <dt>Owner</dt>
                    <dd>{{ asset.owner.display_name if asset.owner else '—' }}</dd>
                    <dt>Department</dt>
                    <dd>{{ asset.department or '—' }}</dd>
                    <dt>Location</dt>
                    <dd>{{ asset.location or '—' }}</dd>
                </dl>
            </div>
        </div>

        {# Provider #}
        <div class="card mb-3">
            <div class="card-header"><strong><i class="bi bi-building me-1"></i>Provider</strong></div>
            <div class="card-body small">
                <dl class="mb-0">
                    <dt>Vendor</dt>
                    <dd>
                        {% if asset.vendor %}
                        <a href="/vendors/{{ asset.vendor.id }}">{{ asset.vendor.name }}</a>
                        {% else %}—{% endif %}
                    </dd>
                    <dt>Provider</dt>
                    <dd>{{ asset.provider or '—' }}</dd>
                </dl>
            </div>
        </div>

        {# Lifecycle #}
        <div class="card mb-3">
            <div class="card-header"><strong><i class="bi bi-calendar-event me-1"></i>Lifecycle</strong></div>
            <div class="card-body small">
                <dl class="mb-0">
                    <dt>Acquired Date</dt>
                    <dd>{{ asset.acquired_date.strftime('%Y-%m-%d') if asset.acquired_date else '—' }}</dd>
                    <dt>End of Life Date</dt>
                    <dd>
                        {% if asset.end_of_life_date %}
                        {% set today = None %}
                        <span class="{% if asset.end_of_life_date < asset.created_at.__class__.now(asset.created_at.tzinfo) %}text-danger fw-bold{% endif %}">
                            {{ asset.end_of_life_date.strftime('%Y-%m-%d') }}
                        </span>
                        {% else %}—{% endif %}
                    </dd>
                    <dt>Last Scan Date</dt>
                    <dd>{{ asset.last_scan_date.strftime('%Y-%m-%d') if asset.last_scan_date else '—' }}</dd>
                    <dt>Created</dt>
                    <dd>{{ asset.created_at.strftime('%Y-%m-%d') if asset.created_at else '—' }}</dd>
                    <dt>Updated</dt>
                    <dd>{{ asset.updated_at.strftime('%Y-%m-%d') if asset.updated_at else '—' }}</dd>
                </dl>
            </div>
        </div>
    </div>
</div>
{% endblock %}
