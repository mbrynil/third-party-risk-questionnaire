{% extends "base.html" %}

{% block title %}Simulation Results — {{ item.risk.risk_ref if item.risk else 'Risk' }}{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    .kpi-card { text-align: center; padding: 1rem; }
    .kpi-card .kpi-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
    .kpi-card .kpi-label { font-size: 0.7rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }
    .chart-container { position: relative; height: 320px; }
</style>
{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
<li class="breadcrumb-item"><a href="/risk-assessments">Risk Assessments</a></li>
<li class="breadcrumb-item"><a href="/risk-assessments/{{ assessment.id }}">{{ assessment.assessment_ref }}</a></li>
<li class="breadcrumb-item"><a href="/risk-assessments/{{ assessment.id }}/items/{{ item.id }}">{{ item.risk.risk_ref if item.risk else 'Item' }}</a></li>
<li class="breadcrumb-item active">Simulation Results</li>
{% endblock %}

{% block content %}
{# Header #}
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h3 class="mb-1">
            <i class="bi bi-dice-5 me-2"></i>Monte Carlo Simulation Results
        </h3>
        <div class="d-flex gap-2 mt-1 flex-wrap">
            <span class="badge bg-primary">{{ item.risk.risk_ref if item.risk else '—' }} — {{ item.risk.title if item.risk else 'Unknown' }}</span>
            <span class="badge bg-light text-dark">{{ ASSESSMENT_METHODOLOGY_LABELS.get(assessment.methodology, assessment.methodology) }}</span>
            <span class="badge bg-light text-dark">{{ "{:,}".format(run.iterations) }} iterations</span>
            <span class="badge bg-light text-dark">{{ SIMULATION_DISTRIBUTION_LABELS.get(run.distribution_type, run.distribution_type) }}</span>
            <span class="badge bg-light text-dark">{{ run.run_at.strftime('%Y-%m-%d %H:%M') if run.run_at else '—' }}</span>
        </div>
    </div>
    <div class="d-flex gap-2">
        <a href="/risk-assessments/{{ assessment.id }}/items/{{ item.id }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left me-1"></i>Back to Item</a>
    </div>
</div>

{# KPI Row #}
<div class="row g-3 mb-4">
    <div class="col">
        <div class="card kpi-card">
            <div class="kpi-value text-primary">${{ "{:,.0f}".format(run.mean_ale) }}</div>
            <div class="kpi-label">Mean ALE</div>
        </div>
    </div>
    <div class="col">
        <div class="card kpi-card">
            <div class="kpi-value">${{ "{:,.0f}".format(run.median_ale) }}</div>
            <div class="kpi-label">Median ALE</div>
        </div>
    </div>
    <div class="col">
        <div class="card kpi-card">
            <div class="kpi-value text-warning">${{ "{:,.0f}".format(run.p90_ale) }}</div>
            <div class="kpi-label">90th Percentile</div>
        </div>
    </div>
    <div class="col">
        <div class="card kpi-card">
            <div class="kpi-value text-danger">${{ "{:,.0f}".format(run.p95_ale) }}</div>
            <div class="kpi-label">95th Percentile</div>
        </div>
    </div>
    <div class="col">
        <div class="card kpi-card">
            <div class="kpi-value">${{ "{:,.0f}".format(run.std_dev) }}</div>
            <div class="kpi-label">Std Dev</div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    {# Histogram #}
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header"><strong><i class="bi bi-bar-chart me-1"></i>Loss Distribution (Histogram)</strong></div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="histogramChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    {# Exceedance Curve #}
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header"><strong><i class="bi bi-graph-down me-1"></i>Loss Exceedance Curve</strong></div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="exceedanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    {# Sensitivity Tornado #}
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header"><strong><i class="bi bi-tornado me-1"></i>Sensitivity Analysis (Tornado)</strong></div>
            <div class="card-body">
                <div class="chart-container" style="height:220px;">
                    <canvas id="tornadoChart"></canvas>
                </div>
                <div class="small text-muted mt-2">Spearman rank correlation between each FAIR factor and annual loss. Higher absolute values indicate greater influence on loss uncertainty.</div>
            </div>
        </div>
    </div>

    {# Statistics Summary #}
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header"><strong><i class="bi bi-table me-1"></i>Detailed Statistics</strong></div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr><td class="text-muted">Minimum</td><td class="fw-bold text-end">${{ "{:,.0f}".format(run.min_ale) }}</td></tr>
                        <tr><td class="text-muted">5th Percentile</td><td class="fw-bold text-end">${{ "{:,.0f}".format(run.p5_ale) }}</td></tr>
                        <tr><td class="text-muted">10th Percentile</td><td class="fw-bold text-end">${{ "{:,.0f}".format(run.p10_ale) }}</td></tr>
                        <tr><td class="text-muted">Mean</td><td class="fw-bold text-end text-primary">${{ "{:,.0f}".format(run.mean_ale) }}</td></tr>
                        <tr><td class="text-muted">Median</td><td class="fw-bold text-end">${{ "{:,.0f}".format(run.median_ale) }}</td></tr>
                        <tr><td class="text-muted">90th Percentile</td><td class="fw-bold text-end text-warning">${{ "{:,.0f}".format(run.p90_ale) }}</td></tr>
                        <tr><td class="text-muted">95th Percentile</td><td class="fw-bold text-end text-danger">${{ "{:,.0f}".format(run.p95_ale) }}</td></tr>
                        <tr><td class="text-muted">Maximum</td><td class="fw-bold text-end">${{ "{:,.0f}".format(run.max_ale) }}</td></tr>
                        <tr><td class="text-muted">Standard Deviation</td><td class="fw-bold text-end">${{ "{:,.0f}".format(run.std_dev) }}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# Input Summary #}
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header"><strong><i class="bi bi-sliders me-1"></i>FAIR Factor Inputs</strong></div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <thead><tr><th>Factor</th><th class="text-end">Min</th><th class="text-end">Likely</th><th class="text-end">Max</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>TEF <small class="text-muted">(events/yr)</small></td>
                            <td class="text-end">{{ item.tef_min }}</td>
                            <td class="text-end">{{ item.tef_likely }}</td>
                            <td class="text-end">{{ item.tef_max }}</td>
                        </tr>
                        <tr>
                            <td>VULN <small class="text-muted">(probability)</small></td>
                            <td class="text-end">{{ item.vuln_min }}</td>
                            <td class="text-end">{{ item.vuln_likely }}</td>
                            <td class="text-end">{{ item.vuln_max }}</td>
                        </tr>
                        <tr>
                            <td>PLM <small class="text-muted">($)</small></td>
                            <td class="text-end">${{ "{:,.0f}".format(item.plm_min) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(item.plm_likely) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(item.plm_max) }}</td>
                        </tr>
                        <tr>
                            <td>SLM <small class="text-muted">($)</small></td>
                            <td class="text-end">${{ "{:,.0f}".format(item.slm_min) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(item.slm_likely) }}</td>
                            <td class="text-end">${{ "{:,.0f}".format(item.slm_max) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header"><strong><i class="bi bi-shield-check me-1"></i>Control Effectiveness</strong></div>
            <div class="card-body">
                {% if item.control_links %}
                <table class="table table-sm mb-3">
                    <thead><tr><th>Control</th><th>Effectiveness</th><th class="text-end">Weight</th></tr></thead>
                    <tbody>
                        {% for cl in item.control_links %}
                        <tr>
                            <td>{{ cl.implementation.control.control_ref if cl.implementation and cl.implementation.control else '—' }}</td>
                            <td>{{ EFFECTIVENESS_LABELS.get(cl.effectiveness_at_assessment, cl.effectiveness_at_assessment) }}</td>
                            <td class="text-end">{{ cl.weight }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted small fst-italic mb-2">No controls linked to this scenario.</p>
                {% endif %}
                <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background:#f1f5f9;">
                    <span class="fw-semibold">Combined Effectiveness</span>
                    <span class="fw-bold">{{ "{:.1%}".format(run.combined_control_effectiveness or 0) }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    var histogramData = {{ histogram_json|safe }};
    var exceedanceData = {{ exceedance_json|safe }};
    var sensitivityData = {{ sensitivity_json|safe }};
    var meanALE = {{ run.mean_ale }};
    var p90ALE = {{ run.p90_ale }};
    var p95ALE = {{ run.p95_ale }};

    function fmt(val) {
        return '$' + val.toLocaleString('en-US', {maximumFractionDigits: 0});
    }

    // Histogram
    if (histogramData.length > 0) {
        var histCtx = document.getElementById('histogramChart').getContext('2d');
        new Chart(histCtx, {
            type: 'bar',
            data: {
                labels: histogramData.map(function(b) { return fmt(b.bin_start); }),
                datasets: [{
                    label: 'Frequency',
                    data: histogramData.map(function(b) { return b.count; }),
                    backgroundColor: histogramData.map(function(b) {
                        var mid = (b.bin_start + b.bin_end) / 2;
                        if (mid >= p95ALE) return 'rgba(220,53,69,0.7)';
                        if (mid >= p90ALE) return 'rgba(253,126,20,0.7)';
                        if (mid >= meanALE) return 'rgba(255,193,7,0.7)';
                        return 'rgba(13,110,253,0.6)';
                    }),
                    borderWidth: 0,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(items) {
                                var i = items[0].dataIndex;
                                return fmt(histogramData[i].bin_start) + ' — ' + fmt(histogramData[i].bin_end);
                            },
                            label: function(item) { return item.raw + ' iterations'; }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: { display: true, text: 'Annual Loss ($)' },
                        ticks: { maxTicksLimit: 8, callback: function(val, idx) { return idx % 5 === 0 ? this.getLabelForValue(val) : ''; } }
                    },
                    y: { title: { display: true, text: 'Frequency' } }
                }
            }
        });
    }

    // Exceedance Curve
    if (exceedanceData.length > 0) {
        var excCtx = document.getElementById('exceedanceChart').getContext('2d');
        new Chart(excCtx, {
            type: 'line',
            data: {
                labels: exceedanceData.map(function(e) { return e.threshold; }),
                datasets: [{
                    label: 'P(Loss > X)',
                    data: exceedanceData.map(function(e) { return e.probability; }),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220,53,69,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(items) { return fmt(items[0].parsed.x); },
                            label: function(item) { return (item.parsed.y * 100).toFixed(1) + '% probability of exceeding'; }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        title: { display: true, text: 'Loss Threshold ($)' },
                        ticks: { callback: function(val) { return fmt(val); }, maxTicksLimit: 8 }
                    },
                    y: {
                        title: { display: true, text: 'Probability of Exceedance' },
                        min: 0, max: 1,
                        ticks: { callback: function(val) { return (val * 100).toFixed(0) + '%'; } }
                    }
                }
            }
        });
    }

    // Tornado Chart
    if (sensitivityData.length > 0) {
        var torCtx = document.getElementById('tornadoChart').getContext('2d');
        var factorLabels = {'TEF': 'Threat Event Frequency', 'VULN': 'Vulnerability', 'PLM': 'Primary Loss Magnitude', 'SLM': 'Secondary Loss Magnitude'};
        new Chart(torCtx, {
            type: 'bar',
            data: {
                labels: sensitivityData.map(function(s) { return factorLabels[s.factor] || s.factor; }),
                datasets: [{
                    label: 'Correlation',
                    data: sensitivityData.map(function(s) { return s.correlation; }),
                    backgroundColor: sensitivityData.map(function(s) {
                        return s.correlation >= 0 ? 'rgba(13,110,253,0.7)' : 'rgba(220,53,69,0.7)';
                    }),
                    borderWidth: 0,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(item) { return 'Correlation: ' + item.raw.toFixed(3); }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Spearman Rank Correlation' }, min: -1, max: 1 },
                    y: { ticks: { font: { size: 11 } } }
                }
            }
        });
    }
})();
</script>
{% endblock %}
