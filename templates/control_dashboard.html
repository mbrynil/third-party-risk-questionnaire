{% extends "base.html" %}

{% block title %}Control Dashboard{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
<li class="breadcrumb-item active">Control Dashboard</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0"><i class="bi bi-shield-check me-2"></i>Control Program Dashboard</h3>
    <div class="d-flex gap-2">
        <a href="/controls" class="btn btn-outline-primary"><i class="bi bi-shield-lock me-1"></i>Library</a>
        <a href="/controls/gap-analysis" class="btn btn-outline-info"><i class="bi bi-clipboard-data me-1"></i>Gap Analysis</a>
    </div>
</div>

{# KPIs #}
{% set kpis = data.kpis %}
<div class="row g-3 mb-4">
    <div class="col-md col-6">
        <div class="card text-center p-3">
            <div style="font-size:2rem;font-weight:700;color:#2563eb;">{{ kpis.active_controls }}</div>
            <small class="text-muted text-uppercase" style="font-size:0.7rem;letter-spacing:0.05em;">Active Controls</small>
        </div>
    </div>
    <div class="col-md col-6">
        <div class="card text-center p-3">
            <div style="font-size:2rem;font-weight:700;color:{% if kpis.impl_pct >= 70 %}#198754{% elif kpis.impl_pct >= 40 %}#ffc107{% else %}#dc3545{% endif %};">{{ kpis.impl_pct }}%</div>
            <small class="text-muted text-uppercase" style="font-size:0.7rem;letter-spacing:0.05em;">Implemented</small>
        </div>
    </div>
    <div class="col-md col-6">
        <div class="card text-center p-3">
            <div style="font-size:2rem;font-weight:700;color:{% if kpis.eff_pct >= 70 %}#198754{% elif kpis.eff_pct >= 40 %}#ffc107{% else %}#dc3545{% endif %};">{{ kpis.eff_pct }}%</div>
            <small class="text-muted text-uppercase" style="font-size:0.7rem;letter-spacing:0.05em;">Effective</small>
        </div>
    </div>
    <div class="col-md col-6">
        <div class="card text-center p-3">
            <div style="font-size:2rem;font-weight:700;color:{% if kpis.overdue_tests > 0 %}#dc3545{% else %}#198754{% endif %};">{{ kpis.overdue_tests }}</div>
            <small class="text-muted text-uppercase" style="font-size:0.7rem;letter-spacing:0.05em;">Overdue Tests</small>
        </div>
    </div>
    <div class="col-md col-6">
        <div class="card text-center p-3">
            <div style="font-size:2rem;font-weight:700;color:#6f42c1;">{{ kpis.frameworks_covered }}</div>
            <small class="text-muted text-uppercase" style="font-size:0.7rem;letter-spacing:0.05em;">Frameworks</small>
        </div>
    </div>
    <div class="col">
        <div class="card text-center h-100">
            <div class="card-body py-3">
                <div class="fs-2 fw-bold" style="color:{% if avg_health >= 80 %}#198754{% elif avg_health >= 60 %}#0dcaf0{% elif avg_health >= 40 %}#fd7e14{% else %}#dc3545{% endif %}">{{ avg_health }}</div>
                <small class="text-muted">Avg Health Score</small>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card text-center h-100">
            <div class="card-body py-3">
                <div class="fs-2 fw-bold {% if open_findings_count > 0 %}text-danger{% else %}text-success{% endif %}">{{ open_findings_count }}</div>
                <small class="text-muted">Open Findings</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    {# Framework Coverage #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-collection me-1"></i>Framework Coverage</h6></div>
            {% if data.fw_coverage %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>Framework</th><th>Controls</th><th>Coverage</th><th>Effectiveness</th></tr></thead>
                    <tbody>
                        {% for key, fw in data.fw_coverage.items() %}
                        <tr>
                            <td class="fw-semibold">{{ fw.label }}</td>
                            <td>{{ fw.implemented }} / {{ fw.total }}</td>
                            <td>
                                <div class="progress" style="height:16px;min-width:80px;">
                                    <div class="progress-bar bg-{% if fw.coverage_pct >= 70 %}success{% elif fw.coverage_pct >= 40 %}warning{% else %}danger{% endif %}" style="width:{{ fw.coverage_pct }}%;">{{ fw.coverage_pct }}%</div>
                                </div>
                            </td>
                            <td>
                                <div class="progress" style="height:16px;min-width:80px;">
                                    <div class="progress-bar bg-{% if fw.effectiveness_pct >= 70 %}success{% elif fw.effectiveness_pct >= 40 %}warning{% else %}danger{% endif %}" style="width:{{ fw.effectiveness_pct }}%;">{{ fw.effectiveness_pct }}%</div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card-body text-muted">No framework mappings yet. <a href="/controls">Configure controls</a>.</div>
            {% endif %}
        </div>
    </div>

    {# Domain Effectiveness Heatmap #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-grid-3x3 me-1"></i>Domain Effectiveness</h6></div>
            {% if data.domain_heatmap %}
            <div class="card-body">
                <div class="row g-2">
                    {% for d in data.domain_heatmap %}
                    <div class="col-md-6">
                        <div class="d-flex align-items-center gap-2 p-2 rounded" style="background:{{ d.color }}15;border-left:4px solid {{ d.color }};">
                            <div style="font-size:1.1rem;font-weight:700;color:{{ d.color }};min-width:42px;">{{ d.pct }}%</div>
                            <div>
                                <div class="fw-semibold" style="font-size:0.8rem;">{{ d.domain }}</div>
                                <div class="text-muted" style="font-size:0.7rem;">{{ d.effective }}/{{ d.total }} effective</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="card-body text-muted">No control implementations yet.</div>
            {% endif %}
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header"><h6 class="mb-0">Control Health Distribution</h6></div>
    <div class="card-body">
        <div class="row g-3 text-center">
            <div class="col-3"><a href="/controls?health=healthy" class="text-decoration-none"><div class="p-3 rounded" style="background:#19875420;"><div class="fs-4 fw-bold" style="color:#198754">{{ health_distribution.healthy }}</div><small class="text-muted">Healthy</small></div></a></div>
            <div class="col-3"><a href="/controls?health=adequate" class="text-decoration-none"><div class="p-3 rounded" style="background:#0dcaf020;"><div class="fs-4 fw-bold" style="color:#0dcaf0">{{ health_distribution.adequate }}</div><small class="text-muted">Adequate</small></div></a></div>
            <div class="col-3"><a href="/controls?health=at_risk" class="text-decoration-none"><div class="p-3 rounded" style="background:#fd7e1420;"><div class="fs-4 fw-bold" style="color:#fd7e14">{{ health_distribution.at_risk }}</div><small class="text-muted">At Risk</small></div></a></div>
            <div class="col-3"><a href="/controls?health=critical" class="text-decoration-none"><div class="p-3 rounded" style="background:#dc354520;"><div class="fs-4 fw-bold" style="color:#dc3545">{{ health_distribution.critical }}</div><small class="text-muted">Critical</small></div></a></div>
        </div>
    </div>
</div>

<div class="row g-4">
    {# Testing Status #}
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-clipboard-check me-1"></i>Testing Status (YTD)</h6></div>
            <div class="card-body">
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div style="font-size:1.5rem;font-weight:700;">{{ data.testing.total_ytd }}</div>
                        <small class="text-muted">Total Tests</small>
                    </div>
                    <div class="col-6">
                        <div style="font-size:1.5rem;font-weight:700;color:#198754;">{{ data.testing.pass }}</div>
                        <small class="text-muted">Passed</small>
                    </div>
                    <div class="col-6">
                        <div style="font-size:1.5rem;font-weight:700;color:#dc3545;">{{ data.testing.fail }}</div>
                        <small class="text-muted">Failed</small>
                    </div>
                    <div class="col-6">
                        <div style="font-size:1.5rem;font-weight:700;color:#fd7e14;">{{ data.testing.upcoming }}</div>
                        <small class="text-muted">Upcoming (30d)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Recent Tests #}
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-clock-history me-1"></i>Recent Test Results</h6></div>
            {% if data.recent_tests %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>Date</th><th>Control</th><th>Vendor</th><th>Type</th><th>Result</th><th>Tester</th></tr></thead>
                    <tbody>
                        {% for t in data.recent_tests %}
                        <tr>
                            <td><a href="/controls/tests/{{ t.id }}" class="text-decoration-none">{{ t.test_date.strftime('%Y-%m-%d') if t.test_date else '—' }}</a></td>
                            <td>{{ t.implementation.control.control_ref if t.implementation and t.implementation.control else '—' }}</td>
                            <td><small>{{ t.implementation.vendor.name if t.implementation and t.implementation.vendor else '—' }}</small></td>
                            <td><span class="badge bg-secondary" style="font-size:0.7rem;">{{ test_type_labels.get(t.test_type, t.test_type) }}</span></td>
                            <td><span class="badge" style="background-color:{{ test_result_colors.get(t.result, '#6c757d') }}">{{ test_result_labels.get(t.result, t.result) }}</span></td>
                            <td><small>{{ t.tester.display_name if t.tester else '—' }}</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card-body text-muted">No tests recorded yet.</div>
            {% endif %}
        </div>
    </div>
</div>

{# Action Items (Feature 8) #}
{% if action_items %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-1"></i>Action Items <span class="badge bg-danger ms-1">{{ action_items|length }}</span></h6>
        <button type="button" class="btn btn-sm btn-outline-primary" id="myItemsToggle" onclick="toggleMyItems()">
            <i class="bi bi-person me-1"></i>My Items Only
        </button>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead><tr><th style="width:30px;"></th><th>Item</th><th>Control</th><th>Owner</th><th>Due</th><th class="text-end">Link</th></tr></thead>
            <tbody id="actionItemsBody">
                {% for item in action_items[:15] %}
                <tr data-owner="{{ item.owner or '' }}">
                    <td>
                        {% if item.priority == 1 %}<span class="badge bg-danger">!</span>
                        {% elif item.priority == 2 %}<span class="badge bg-warning text-dark">!!</span>
                        {% else %}<span class="badge bg-info">i</span>{% endif %}
                    </td>
                    <td>
                        <small class="fw-semibold">{{ item.title }}</small><br>
                        <small class="text-muted">{{ item.description }}</small>
                    </td>
                    <td><small>{{ item.control_ref }}</small></td>
                    <td><small>{{ item.owner or '—' }}</small></td>
                    <td><small>{{ item.due_date.strftime('%Y-%m-%d') if item.due_date else '—' }}</small></td>
                    <td class="text-end"><a href="{{ item.url }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-right"></i></a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="row g-4">
    {# Test Results Timeline Chart (Feature 9) #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-bar-chart me-1"></i>Test Results Timeline</h6></div>
            <div class="card-body">
                {% if test_timeline and test_timeline|length > 0 %}
                <canvas id="testTimelineChart" height="250"></canvas>
                {% else %}
                <p class="text-muted mb-0">No test data available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# Portfolio Health Trend (Feature 11) #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-graph-up me-1"></i>Portfolio Health Trend</h6>
                <form method="post" action="/controls/record-health-snapshots" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-secondary" title="Record snapshots now"><i class="bi bi-camera"></i></button>
                </form>
            </div>
            <div class="card-body">
                {% if portfolio_trend and portfolio_trend|length > 0 %}
                <canvas id="portfolioTrendChart" height="250"></canvas>
                {% else %}
                <p class="text-muted mb-0">No health snapshots recorded yet. Click the camera icon to record your first snapshot.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
{% if test_timeline and test_timeline|length > 0 %}
const tl = {{ test_timeline|tojson }};
new Chart(document.getElementById('testTimelineChart'), {
    type: 'bar',
    data: {
        labels: tl.map(d => d.month),
        datasets: [
            { label: 'Pass', data: tl.map(d => d.pass_count), backgroundColor: '#198754' },
            { label: 'Fail', data: tl.map(d => d.fail_count), backgroundColor: '#dc3545' },
            { label: 'Partial', data: tl.map(d => d.partial_count), backgroundColor: '#fd7e14' },
        ]
    },
    options: {
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
        plugins: { legend: { position: 'bottom' } },
    }
});
{% endif %}
{% if portfolio_trend and portfolio_trend|length > 0 %}
const pt = {{ portfolio_trend|tojson }};
new Chart(document.getElementById('portfolioTrendChart'), {
    type: 'line',
    data: {
        labels: pt.map(d => d.date),
        datasets: [{
            label: 'Avg Health Score',
            data: pt.map(d => d.avg_score),
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.1)',
            fill: true,
            tension: 0.3,
        }]
    },
    options: {
        scales: { y: { min: 0, max: 100 } },
        plugins: { legend: { display: false } },
    }
});
{% endif %}

// My Items toggle
var myItemsActive = false;
function toggleMyItems() {
    myItemsActive = !myItemsActive;
    var btn = document.getElementById('myItemsToggle');
    var currentUserName = {{ (current_user.display_name if current_user else '')|tojson }};
    var rows = document.querySelectorAll('#actionItemsBody tr');

    if (myItemsActive) {
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-primary');
        rows.forEach(function(row) {
            row.style.display = (row.dataset.owner === currentUserName) ? '' : 'none';
        });
    } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
        rows.forEach(function(row) {
            row.style.display = '';
        });
    }
}
</script>
{% endblock %}
