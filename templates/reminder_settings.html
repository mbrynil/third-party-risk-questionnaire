{% extends "base.html" %}

{% block title %}Reminder Settings - RiskQ{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-bell me-2"></i>Automated Reminders</h1>
        <p>Configure automatic follow-up emails for outstanding assessments</p>
    </div>
    <form action="/settings/reminders/run-now" method="post" class="d-inline">
        <button type="submit" class="btn btn-outline-primary" title="Manually trigger a reminder check now">
            <i class="bi bi-play-circle me-1"></i>Run Now
        </button>
    </form>
</div>

{% if request.query_params.get('saved') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle me-2"></i>Reminder settings saved successfully!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if request.query_params.get('ran') %}
<div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="bi bi-lightning me-2"></i>
    Manual reminder check complete:
    <strong>{{ request.query_params.get('sent', 0) }}</strong> reminders sent,
    <strong>{{ request.query_params.get('escalated', 0) }}</strong> escalations sent.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <!-- Stats Cards -->
    <div class="col-12 mb-4">
        <div class="row g-3">
            <div class="col-md-3 col-6">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <div class="fs-3 fw-bold text-primary">{{ stats.awaiting_response }}</div>
                        <small class="text-muted">Awaiting Response</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <div class="fs-3 fw-bold text-warning">{{ stats.overdue_responses }}</div>
                        <small class="text-muted">Overdue (7+ days)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <div class="fs-3 fw-bold text-info">{{ stats.total_reminders_sent }}</div>
                        <small class="text-muted">Reminders Sent</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <div class="fs-3 fw-bold text-danger">{{ stats.total_escalations }}</div>
                        <small class="text-muted">Escalations</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Form -->
    <div class="col-lg-7">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Configuration</h6>
            </div>
            <div class="card-body">
                <form action="/settings/reminders" method="post">
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="enabled" name="enabled" value="on"
                                   {% if config.enabled %}checked{% endif %}>
                            <label class="form-check-label fw-semibold" for="enabled">
                                Enable automated reminders
                            </label>
                        </div>
                        <small class="text-muted">When enabled, the system automatically sends follow-up emails to vendors who haven't responded.</small>
                    </div>

                    <hr>

                    <h6 class="text-muted mb-3">Timing</h6>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="first_reminder_days" class="form-label">First reminder after</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="first_reminder_days"
                                       name="first_reminder_days" value="{{ config.first_reminder_days }}" min="1" max="30">
                                <span class="input-group-text">days</span>
                            </div>
                            <small class="text-muted">Days to wait after initial send before first reminder</small>
                        </div>
                        <div class="col-md-6">
                            <label for="frequency_days" class="form-label">Then remind every</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="frequency_days"
                                       name="frequency_days" value="{{ config.frequency_days }}" min="1" max="30">
                                <span class="input-group-text">days</span>
                            </div>
                            <small class="text-muted">Days between subsequent reminders</small>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="max_reminders" class="form-label">Maximum reminders</label>
                            <input type="number" class="form-control" id="max_reminders"
                                   name="max_reminders" value="{{ config.max_reminders }}" min="1" max="10">
                            <small class="text-muted">Stop sending after this many reminders</small>
                        </div>
                        <div class="col-md-6">
                            <label for="final_notice_days_before_expiry" class="form-label">Final notice before expiry</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="final_notice_days_before_expiry"
                                       name="final_notice_days_before_expiry"
                                       value="{{ config.final_notice_days_before_expiry }}" min="0" max="14">
                                <span class="input-group-text">days</span>
                            </div>
                            <small class="text-muted">Send a final notice this many days before expiry (0 to disable)</small>
                        </div>
                    </div>

                    <hr>

                    <h6 class="text-muted mb-3">Escalation</h6>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="escalation_after" class="form-label">Escalate after</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="escalation_after"
                                       name="escalation_after" value="{{ config.escalation_after }}" min="1" max="10">
                                <span class="input-group-text">reminders</span>
                            </div>
                            <small class="text-muted">Send internal escalation after this many unanswered reminders</small>
                        </div>
                        <div class="col-md-6">
                            <label for="escalation_email" class="form-label">Escalation email</label>
                            <input type="email" class="form-control" id="escalation_email"
                                   name="escalation_email" value="{{ config.escalation_email or '' }}"
                                   placeholder="analyst@company.com">
                            <small class="text-muted">Internal email to notify when vendor doesn't respond</small>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            {% if config.updated_at %}
                            Last updated: {{ config.updated_at.strftime('%Y-%m-%d %H:%M') }}
                            {% endif %}
                        </small>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- How it works + Recent Activity -->
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>How It Works</h6>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-start mb-3">
                    <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 28px; height: 28px; line-height: 20px;">1</span>
                    <div>
                        <strong>Assessment Sent</strong>
                        <p class="text-muted small mb-0">You send an assessment to a vendor contact via email</p>
                    </div>
                </div>
                <div class="d-flex align-items-start mb-3">
                    <span class="badge bg-warning text-dark rounded-circle me-3 mt-1" style="width: 28px; height: 28px; line-height: 20px;">2</span>
                    <div>
                        <strong>Automatic Reminders</strong>
                        <p class="text-muted small mb-0">System sends follow-ups at your configured intervals</p>
                    </div>
                </div>
                <div class="d-flex align-items-start mb-3">
                    <span class="badge bg-danger rounded-circle me-3 mt-1" style="width: 28px; height: 28px; line-height: 20px;">3</span>
                    <div>
                        <strong>Escalation</strong>
                        <p class="text-muted small mb-0">After max reminders, an internal escalation is triggered</p>
                    </div>
                </div>
                <div class="d-flex align-items-start">
                    <span class="badge bg-success rounded-circle me-3 mt-1" style="width: 28px; height: 28px; line-height: 20px;">4</span>
                    <div>
                        <strong>Vendor Responds</strong>
                        <p class="text-muted small mb-0">Reminders stop automatically when the assessment is submitted</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Activity</h6>
                <span class="badge bg-secondary">{{ recent_logs|length }}</span>
            </div>
            {% if recent_logs %}
            <div class="list-group list-group-flush" style="max-height: 350px; overflow-y: auto;">
                {% for log in recent_logs %}
                <div class="list-group-item py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            {% if log.reminder_type == 'REMINDER' %}
                            <span class="badge bg-warning text-dark me-1">Reminder #{{ log.reminder_number }}</span>
                            {% elif log.reminder_type == 'ESCALATION' %}
                            <span class="badge bg-danger me-1">Escalation</span>
                            {% elif log.reminder_type == 'FINAL_NOTICE' %}
                            <span class="badge bg-dark me-1">Final Notice</span>
                            {% else %}
                            <span class="badge bg-secondary me-1">{{ log.reminder_type }}</span>
                            {% endif %}
                            <small class="text-muted">{{ log.to_email }}</small>
                        </div>
                        <small class="text-muted">{{ log.sent_at.strftime('%m/%d %H:%M') }}</small>
                    </div>
                    {% if log.assessment %}
                    <small class="text-muted d-block mt-1">{{ log.assessment.title }} â€” {{ log.assessment.company_name }}</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center py-4">
                <i class="bi bi-clock text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted small mt-2 mb-0">No reminders sent yet</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
