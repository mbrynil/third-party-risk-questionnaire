{% extends "base.html" %}

{% block title %}Create Questionnaire - RiskQ{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-plus-circle me-2"></i>Create New Questionnaire</h1>
    <p>Build a custom risk assessment questionnaire for your vendors</p>
</div>

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<form method="post" action="/create">
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-info-circle me-2"></i>Basic Information
        </div>
        <div class="card-body p-4">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="company_name" class="form-label">
                        <i class="bi bi-building me-1"></i>Your Company Name
                    </label>
                    <input type="text" class="form-control" id="company_name" name="company_name" required 
                           placeholder="e.g., Acme Corporation">
                    <div class="form-text">Your company name will appear in the vendor link</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="title" class="form-label">
                        <i class="bi bi-tag me-1"></i>Questionnaire Title
                    </label>
                    <input type="text" class="form-control" id="title" name="title" required 
                           placeholder="e.g., Vendor Security Assessment 2024">
                    <div class="form-text">Give your questionnaire a clear, descriptive name</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-collection me-2"></i>Question Bank</span>
            <div class="d-flex gap-2">
                <input type="text" class="form-control form-control-sm" id="searchQuestions" 
                       placeholder="Search questions..." style="width: 250px;">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                    <i class="bi bi-check-all me-1"></i>Select All
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                    <i class="bi bi-x-lg me-1"></i>Clear All
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">
                <i class="bi bi-info-circle me-1"></i>
                Select questions from our curated GRC question bank. Questions will be added to your questionnaire in the order shown.
            </p>
            
            {% for category, items in categories.items() %}
            <div class="category-section mb-4" data-category="{{ category }}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        <span class="badge bg-primary me-2">{{ category }}</span>
                        <small class="text-muted">({{ items|length }} questions)</small>
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                            onclick="selectCategory('{{ category }}')">
                        Select All in {{ category }}
                    </button>
                </div>
                <div class="list-group">
                    {% for item in items %}
                    <label class="list-group-item list-group-item-action question-item" data-text="{{ item.text|lower }}">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="d-flex align-items-start flex-grow-1">
                                <input class="form-check-input me-3 mt-1 question-checkbox" 
                                       type="checkbox" name="question_ids" value="{{ item.id }}"
                                       data-category="{{ category }}" data-qid="{{ item.id }}">
                                <span>{{ item.text }}</span>
                            </div>
                            <select class="form-select form-select-sm weight-select ms-2" 
                                    name="weight_{{ item.id }}" style="width: 100px; display: none;"
                                    data-qid="{{ item.id }}">
                                <option value="LOW">Low</option>
                                <option value="MEDIUM" selected>Medium</option>
                                <option value="HIGH">High</option>
                                <option value="CRITICAL">Critical</option>
                            </select>
                            <select class="form-select form-select-sm expected-select ms-2" 
                                    name="expected_{{ item.id }}" style="width: 110px; display: none;"
                                    data-qid="{{ item.id }}">
                                <option value="">Expected...</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="partial">Partial</option>
                                <option value="na">N/A</option>
                            </select>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-pencil me-2"></i>Custom Questions (Optional)
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="custom_questions" class="form-label">Add your own questions</label>
                <textarea class="form-control" id="custom_questions" name="custom_questions" rows="4" 
                          placeholder="Enter each custom question on a new line..."></textarea>
                <div class="form-text">These will be added after the selected bank questions.</div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="text-muted">Selected: </span>
                    <span id="selectedCount" class="badge bg-primary">0</span>
                    <span class="text-muted"> questions</span>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Create Questionnaire
                    </button>
                    <a href="/" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
    
    document.querySelectorAll('.question-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
            toggleWeightSelect(this);
        });
    });
    
    document.getElementById('searchQuestions').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.question-item').forEach(function(item) {
            const text = item.dataset.text;
            if (text.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
        
        document.querySelectorAll('.category-section').forEach(function(section) {
            const visibleItems = section.querySelectorAll('.question-item:not([style*="display: none"])');
            if (visibleItems.length === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = '';
            }
        });
    });
});

function updateSelectedCount() {
    const count = document.querySelectorAll('.question-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count;
}

function selectCategory(category) {
    document.querySelectorAll('.question-checkbox[data-category="' + category + '"]').forEach(function(checkbox) {
        if (checkbox.closest('.question-item').style.display !== 'none') {
            checkbox.checked = true;
            toggleWeightSelect(checkbox);
        }
    });
    updateSelectedCount();
}

function toggleWeightSelect(checkbox) {
    const qid = checkbox.dataset.qid;
    const weightSelect = document.querySelector('.weight-select[data-qid="' + qid + '"]');
    const expectedSelect = document.querySelector('.expected-select[data-qid="' + qid + '"]');
    if (weightSelect) {
        weightSelect.style.display = checkbox.checked ? 'block' : 'none';
    }
    if (expectedSelect) {
        expectedSelect.style.display = checkbox.checked ? 'block' : 'none';
    }
}

function selectAll() {
    document.querySelectorAll('.question-checkbox').forEach(function(checkbox) {
        if (checkbox.closest('.question-item').style.display !== 'none') {
            checkbox.checked = true;
            toggleWeightSelect(checkbox);
        }
    });
    updateSelectedCount();
}

function deselectAll() {
    document.querySelectorAll('.question-checkbox').forEach(function(checkbox) {
        checkbox.checked = false;
        toggleWeightSelect(checkbox);
    });
    updateSelectedCount();
}
</script>
{% endblock %}
