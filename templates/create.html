{% extends "base.html" %}

{% block title %}Create Questionnaire - RiskQ{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-plus-circle me-2"></i>Create New Questionnaire</h1>
    <p>Build a custom risk assessment questionnaire for your vendors</p>
</div>

{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<form method="post" action="/create">
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-info-circle me-2"></i>Basic Information
        </div>
        <div class="card-body p-4">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="company_name" class="form-label">
                        <i class="bi bi-building me-1"></i>Your Company Name
                    </label>
                    <input type="text" class="form-control" id="company_name" name="company_name" required 
                           placeholder="e.g., Acme Corporation">
                    <div class="form-text">Your company name will appear in the vendor link</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="title" class="form-label">
                        <i class="bi bi-tag me-1"></i>Questionnaire Title
                    </label>
                    <input type="text" class="form-control" id="title" name="title" required 
                           placeholder="e.g., Vendor Security Assessment 2024">
                    <div class="form-text">Give your questionnaire a clear, descriptive name</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-collection me-2"></i>Question Bank</span>
            <div class="d-flex gap-2">
                <input type="text" class="form-control form-control-sm" id="searchQuestions" 
                       placeholder="Search questions..." style="width: 250px;">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                    <i class="bi bi-check-all me-1"></i>Select All
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                    <i class="bi bi-x-lg me-1"></i>Clear All
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">
                <i class="bi bi-info-circle me-1"></i>
                Select questions from our curated GRC question bank. Questions will be added to your questionnaire in the order shown.
            </p>
            
            {% for category, items in categories.items() %}
            <div class="category-section mb-4" data-category="{{ category }}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        <span class="badge bg-primary me-2">{{ category }}</span>
                        <small class="text-muted">({{ items|length }} questions)</small>
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                            onclick="selectCategory('{{ category }}')">
                        Select All in {{ category }}
                    </button>
                </div>
                <div class="list-group">
                    {% for item in items %}
                    <label class="list-group-item list-group-item-action question-item" data-text="{{ item.text|lower }}">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="d-flex align-items-start flex-grow-1">
                                <input class="form-check-input me-3 mt-1 question-checkbox" 
                                       type="checkbox" name="question_ids" value="{{ item.id }}"
                                       data-category="{{ category }}" data-qid="{{ item.id }}">
                                <span>{{ item.text }}</span>
                            </div>
                            <select class="form-select form-select-sm weight-select ms-2" 
                                    name="weight_{{ item.id }}" style="width: 100px; display: none;"
                                    data-qid="{{ item.id }}">
                                <option value="LOW">Low</option>
                                <option value="MEDIUM" selected>Medium</option>
                                <option value="HIGH">High</option>
                                <option value="CRITICAL">Critical</option>
                            </select>
                            <div class="expected-checkboxes ms-2 d-flex gap-1 flex-wrap" style="display: none;" data-qid="{{ item.id }}">
                                <span class="text-muted small me-1" style="line-height: 1.8;">Expected:</span>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="expected_{{ item.id }}[]" value="yes" id="exp_yes_{{ item.id }}">
                                    <label class="form-check-label small" for="exp_yes_{{ item.id }}">Yes</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="expected_{{ item.id }}[]" value="no" id="exp_no_{{ item.id }}">
                                    <label class="form-check-label small" for="exp_no_{{ item.id }}">No</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="expected_{{ item.id }}[]" value="partial" id="exp_partial_{{ item.id }}">
                                    <label class="form-check-label small" for="exp_partial_{{ item.id }}">Partial</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="expected_{{ item.id }}[]" value="na" id="exp_na_{{ item.id }}">
                                    <label class="form-check-label small" for="exp_na_{{ item.id }}">N/A</label>
                                </div>
                            </div>
                            <select class="form-select form-select-sm answer-mode-select ms-2" 
                                    name="answer_mode_{{ item.id }}" style="width: 120px; display: none;"
                                    data-qid="{{ item.id }}">
                                <option value="SINGLE" selected>Single Choice</option>
                                <option value="MULTI">Multi-Select</option>
                            </select>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-pencil me-2"></i>Custom Questions (Optional)
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="custom_questions" class="form-label">Add your own questions</label>
                <textarea class="form-control" id="custom_questions" name="custom_questions" rows="4" 
                          placeholder="Enter each custom question on a new line..."></textarea>
                <div class="form-text">These will be added after the selected bank questions.</div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-diagram-3 me-2"></i>Conditional Logic (Optional)
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                <i class="bi bi-info-circle me-1"></i>
                Add rules to show follow-up questions based on vendor answers. For example: "If vendor answers No to Question A, show Question B."
            </p>
            
            <div id="rulesContainer">
            </div>
            
            <div id="addRuleSection" class="border rounded p-3 bg-light mb-3" style="display: none;">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label small">If answer to:</label>
                        <select class="form-select form-select-sm" id="newRuleTrigger">
                            <option value="">Select trigger question...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Is any of:</label>
                        <div id="newRuleTriggerValues" class="d-flex flex-wrap gap-1">
                            <span class="text-muted small">Select trigger first</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Then show:</label>
                        <select class="form-select form-select-sm" id="newRuleTarget">
                            <option value="">Select target question...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="newRuleRequired">
                            <label class="form-check-label small" for="newRuleRequired">Required</label>
                        </div>
                        <button type="button" class="btn btn-sm btn-success w-100" onclick="saveRule()">
                            <i class="bi bi-plus me-1"></i>Add
                        </button>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-outline-primary btn-sm" id="showAddRuleBtn" onclick="showAddRuleForm()">
                <i class="bi bi-plus-circle me-1"></i>Add Conditional Rule
            </button>
            
            <input type="hidden" id="conditionalRulesData" name="conditional_rules" value="[]">
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="text-muted">Selected: </span>
                    <span id="selectedCount" class="badge bg-primary">0</span>
                    <span class="text-muted"> questions</span>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Create Questionnaire
                    </button>
                    <a href="/" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
    
    document.querySelectorAll('.question-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
            toggleWeightSelect(this);
        });
    });
    
    document.getElementById('searchQuestions').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.question-item').forEach(function(item) {
            const text = item.dataset.text;
            if (text.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
        
        document.querySelectorAll('.category-section').forEach(function(section) {
            const visibleItems = section.querySelectorAll('.question-item:not([style*="display: none"])');
            if (visibleItems.length === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = '';
            }
        });
    });
});

function updateSelectedCount() {
    const count = document.querySelectorAll('.question-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count;
}

function selectCategory(category) {
    document.querySelectorAll('.question-checkbox[data-category="' + category + '"]').forEach(function(checkbox) {
        if (checkbox.closest('.question-item').style.display !== 'none') {
            checkbox.checked = true;
            toggleWeightSelect(checkbox);
        }
    });
    updateSelectedCount();
}

function toggleWeightSelect(checkbox) {
    const qid = checkbox.dataset.qid;
    const weightSelect = document.querySelector('.weight-select[data-qid="' + qid + '"]');
    const expectedCheckboxes = document.querySelector('.expected-checkboxes[data-qid="' + qid + '"]');
    const answerModeSelect = document.querySelector('.answer-mode-select[data-qid="' + qid + '"]');
    if (weightSelect) {
        weightSelect.style.display = checkbox.checked ? 'block' : 'none';
    }
    if (expectedCheckboxes) {
        expectedCheckboxes.style.display = checkbox.checked ? 'flex' : 'none';
    }
    if (answerModeSelect) {
        answerModeSelect.style.display = checkbox.checked ? 'block' : 'none';
    }
}

function selectAll() {
    document.querySelectorAll('.question-checkbox').forEach(function(checkbox) {
        if (checkbox.closest('.question-item').style.display !== 'none') {
            checkbox.checked = true;
            toggleWeightSelect(checkbox);
        }
    });
    updateSelectedCount();
}

function deselectAll() {
    document.querySelectorAll('.question-checkbox').forEach(function(checkbox) {
        checkbox.checked = false;
        toggleWeightSelect(checkbox);
    });
    updateSelectedCount();
}

// Conditional Rules Logic
let conditionalRules = [];

function getSelectedQuestions() {
    const selected = [];
    document.querySelectorAll('.question-checkbox:checked').forEach(function(checkbox) {
        const qid = checkbox.dataset.qid;
        const label = checkbox.closest('.question-item');
        const text = label ? label.querySelector('span').textContent.trim() : 'Question ' + qid;
        selected.push({ id: qid, text: text.substring(0, 60) + (text.length > 60 ? '...' : '') });
    });
    return selected;
}

function showAddRuleForm() {
    const questions = getSelectedQuestions();
    if (questions.length < 2) {
        alert('Please select at least 2 questions before adding conditional rules.');
        return;
    }
    
    const triggerSelect = document.getElementById('newRuleTrigger');
    const targetSelect = document.getElementById('newRuleTarget');
    
    triggerSelect.innerHTML = '<option value="">Select trigger question...</option>';
    targetSelect.innerHTML = '<option value="">Select target question...</option>';
    
    questions.forEach(function(q, idx) {
        triggerSelect.innerHTML += `<option value="${q.id}" data-text="${q.text}">Q${idx+1}: ${q.text}</option>`;
        targetSelect.innerHTML += `<option value="${q.id}" data-text="${q.text}">Q${idx+1}: ${q.text}</option>`;
    });
    
    document.getElementById('newRuleTriggerValues').innerHTML = '<span class="text-muted small">Select trigger first</span>';
    document.getElementById('newRuleRequired').checked = false;
    
    document.getElementById('addRuleSection').style.display = 'block';
    document.getElementById('showAddRuleBtn').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('newRuleTrigger').addEventListener('change', function() {
        const container = document.getElementById('newRuleTriggerValues');
        if (!this.value) {
            container.innerHTML = '<span class="text-muted small">Select trigger first</span>';
            return;
        }
        container.innerHTML = `
            <div class="form-check form-check-inline">
                <input class="form-check-input trigger-value-cb" type="checkbox" value="yes" id="tv_yes">
                <label class="form-check-label small" for="tv_yes">Yes</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input trigger-value-cb" type="checkbox" value="no" id="tv_no">
                <label class="form-check-label small" for="tv_no">No</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input trigger-value-cb" type="checkbox" value="partial" id="tv_partial">
                <label class="form-check-label small" for="tv_partial">Partial</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input trigger-value-cb" type="checkbox" value="na" id="tv_na">
                <label class="form-check-label small" for="tv_na">N/A</label>
            </div>
        `;
    });
});

function saveRule() {
    const triggerSelect = document.getElementById('newRuleTrigger');
    const targetSelect = document.getElementById('newRuleTarget');
    const triggerQid = triggerSelect.value;
    const targetQid = targetSelect.value;
    const makeRequired = document.getElementById('newRuleRequired').checked;
    
    if (!triggerQid || !targetQid) {
        alert('Please select both trigger and target questions.');
        return;
    }
    
    if (triggerQid === targetQid) {
        alert('Trigger and target questions cannot be the same.');
        return;
    }
    
    const triggerValues = [];
    document.querySelectorAll('.trigger-value-cb:checked').forEach(function(cb) {
        triggerValues.push(cb.value);
    });
    
    if (triggerValues.length === 0) {
        alert('Please select at least one trigger answer.');
        return;
    }
    
    const triggerText = triggerSelect.options[triggerSelect.selectedIndex].dataset.text;
    const targetText = targetSelect.options[targetSelect.selectedIndex].dataset.text;
    
    const rule = {
        trigger_question_id: triggerQid,
        trigger_values: triggerValues,
        target_question_id: targetQid,
        make_required: makeRequired,
        trigger_text: triggerText,
        target_text: targetText
    };
    
    conditionalRules.push(rule);
    updateRulesDisplay();
    
    document.getElementById('addRuleSection').style.display = 'none';
    document.getElementById('showAddRuleBtn').style.display = 'inline-block';
}

function updateRulesDisplay() {
    const container = document.getElementById('rulesContainer');
    container.innerHTML = '';
    
    conditionalRules.forEach(function(rule, idx) {
        const valuesText = rule.trigger_values.map(v => v.charAt(0).toUpperCase() + v.slice(1)).join(' or ');
        const reqText = rule.make_required ? ' (required)' : '';
        container.innerHTML += `
            <div class="alert alert-secondary py-2 d-flex justify-content-between align-items-center mb-2">
                <span>
                    <i class="bi bi-arrow-right-circle me-2"></i>
                    If <strong>"${rule.trigger_text}"</strong> is <span class="badge bg-warning text-dark">${valuesText}</span>, 
                    then show <strong>"${rule.target_text}"</strong>${reqText}
                </span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteRule(${idx})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
    });
    
    document.getElementById('conditionalRulesData').value = JSON.stringify(conditionalRules);
}

function deleteRule(idx) {
    conditionalRules.splice(idx, 1);
    updateRulesDisplay();
}
</script>
{% endblock %}
