{% extends "base.html" %}

{% block title %}Risk Dashboard{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
<li class="breadcrumb-item"><a href="/risks">Risk Register</a></li>
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Risk Dashboard</h3>
    <div class="d-flex gap-2">
        <a href="/risks" class="btn btn-outline-primary"><i class="bi bi-shield-exclamation me-1"></i>Register</a>
        <a href="/risks/heatmap" class="btn btn-outline-secondary"><i class="bi bi-grid-3x3 me-1"></i>Heatmap</a>
    </div>
</div>

{# KPI Row #}
<div class="row g-3 mb-4">
    <div class="col-md col-6">
        <div class="card text-center p-3">
            <div style="font-size:2rem;font-weight:700;color:#2563eb;">{{ data.total }}</div>
            <small class="text-muted text-uppercase" style="font-size:0.7rem;letter-spacing:0.05em;">Total Risks</small>
        </div>
    </div>
    <div class="col-md col-6">
        <div class="card text-center p-3">
            <div style="font-size:2rem;font-weight:700;color:{% if data.above_appetite > 0 %}#dc3545{% else %}#198754{% endif %};">{{ data.above_appetite }}</div>
            <small class="text-muted text-uppercase" style="font-size:0.7rem;letter-spacing:0.05em;">Above Appetite</small>
        </div>
    </div>
    {% for s, count in data.by_status.items() %}
    <div class="col-md col-6">
        <div class="card text-center p-3">
            <div style="font-size:2rem;font-weight:700;color:{{ data.status_colors[s] }};">{{ count }}</div>
            <small class="text-muted text-uppercase" style="font-size:0.7rem;letter-spacing:0.05em;">{{ data.status_labels[s] }}</small>
        </div>
    </div>
    {% endfor %}
</div>

<div class="row g-4">
    {# Status Breakdown #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-bar-chart-fill me-1"></i>Status Breakdown</h6></div>
            <div class="card-body">
                {% if data.total > 0 %}
                {% for s, count in data.by_status.items() %}
                {% set pct = (count / data.total * 100)|round(1) if data.total > 0 else 0 %}
                <div class="d-flex align-items-center mb-2">
                    <div style="min-width:90px;" class="small fw-semibold">{{ data.status_labels[s] }}</div>
                    <div class="flex-grow-1 mx-2">
                        <div class="progress" style="height:20px;">
                            <div class="progress-bar" style="width:{{ pct }}%;background-color:{{ data.status_colors[s] }};">
                                {% if pct >= 10 %}{{ count }}{% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="small text-muted" style="min-width:50px;text-align:right;">{{ count }} ({{ pct }}%)</div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted mb-0">No risks recorded yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# Treatment Type Breakdown #}
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-bandaid me-1"></i>Treatment Type Breakdown</h6></div>
            <div class="card-body">
                {% set treatment_colors = {"MITIGATE": "#0d6efd", "ACCEPT": "#198754", "TRANSFER": "#6f42c1", "AVOID": "#fd7e14"} %}
                {% set treated_total = data.by_treatment.values()|sum %}
                {% if treated_total > 0 %}
                {% for t, count in data.by_treatment.items() %}
                {% set pct = (count / treated_total * 100)|round(1) if treated_total > 0 else 0 %}
                <div class="d-flex align-items-center mb-2">
                    <div style="min-width:80px;" class="small fw-semibold">{{ data.treatment_labels[t] }}</div>
                    <div class="flex-grow-1 mx-2">
                        <div class="progress" style="height:20px;">
                            <div class="progress-bar" style="width:{{ pct }}%;background-color:{{ treatment_colors[t] }};">
                                {% if pct >= 10 %}{{ count }}{% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="small text-muted" style="min-width:50px;text-align:right;">{{ count }}</div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted mb-0">No treatment plans assigned yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# Risk Level Distribution #}
<div class="card mb-4">
    <div class="card-header"><h6 class="mb-0"><i class="bi bi-thermometer-half me-1"></i>Risk Level Distribution</h6></div>
    <div class="card-body">
        {% set level_order = ["Critical", "High", "Medium", "Low", "Very Low", "Not Rated"] %}
        <div class="row g-3 text-center">
            {% for level in level_order %}
            {% set count = data.by_level.get(level, 0) %}
            <div class="col-2">
                <a href="/risks?risk_level={{ level }}" class="text-decoration-none">
                    <div class="p-3 rounded" style="background:{{ data.level_colors[level] }}15;">
                        <div class="fs-4 fw-bold" style="color:{{ data.level_colors[level] }};">{{ count }}</div>
                        <small class="text-muted">{{ level }}</small>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="row g-4">
    {# Top 10 Risks #}
    <div class="col-lg-7">
        <div class="card mb-4">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-exclamation-triangle me-1"></i>Top 10 Risks (by Inherent Score)</h6></div>
            {% if data.top_risks %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width:80px;">Ref</th>
                            <th>Title</th>
                            <th style="width:60px;">Score</th>
                            <th style="width:90px;">Level</th>
                            <th style="width:90px;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in data.top_risks %}
                        <tr>
                            <td><a href="/risks/{{ r.id }}" class="text-decoration-none fw-semibold">{{ r.risk_ref }}</a></td>
                            <td><a href="/risks/{{ r.id }}" class="text-decoration-none">{{ r.title[:60] }}{% if r.title|length > 60 %}...{% endif %}</a></td>
                            <td class="fw-bold">{{ r.inherent_risk_score }}</td>
                            <td>
                                <span class="badge" style="background:{{ RISK_LEVEL_COLORS[get_risk_level_label(r.inherent_risk_score)] }};">{{ get_risk_level_label(r.inherent_risk_score) }}</span>
                            </td>
                            <td>
                                <span class="badge" style="background:{{ data.status_colors[r.status] }};font-size:0.65rem;">{{ data.status_labels[r.status] }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card-body text-muted">No assessed risks yet.</div>
            {% endif %}
        </div>
    </div>

    {# Mini Heatmap #}
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-grid-3x3 me-1"></i>Risk Heatmap</h6>
                <a href="/risks/heatmap" class="btn btn-sm btn-outline-secondary">Full View</a>
            </div>
            <div class="card-body p-2">
                {% set cell_colors = {
                    1: "#198754", 2: "#198754", 3: "#20c997", 4: "#20c997", 5: "#20c997",
                    6: "#a3d977", 7: "#a3d977", 8: "#a3d977", 9: "#a3d977", 10: "#a3d977",
                    11: "#ffc107", 12: "#ffc107", 13: "#ffc107", 14: "#ffc107", 15: "#ffc107",
                    16: "#fd7e14", 17: "#fd7e14", 18: "#fd7e14", 19: "#fd7e14", 20: "#fd7e14",
                    21: "#dc3545", 22: "#dc3545", 23: "#dc3545", 24: "#dc3545", 25: "#dc3545"
                } %}
                <table class="w-100" style="border-collapse:separate;border-spacing:2px;">
                    <tbody>
                        {% for likelihood in [5, 4, 3, 2, 1] %}
                        <tr>
                            <td style="width:20px;font-size:0.6rem;text-align:center;color:#6b7280;">{{ likelihood }}</td>
                            {% for impact in [1, 2, 3, 4, 5] %}
                            {% set score = likelihood * impact %}
                            {% set cell_risks = data.heatmap.get((likelihood, impact), []) %}
                            {% set count = cell_risks|length %}
                            <td style="width:20%;height:40px;background:{{ cell_colors[score] }}{{ '40' if count == 0 else '' }};text-align:center;border-radius:4px;cursor:{% if count > 0 %}pointer{% else %}default{% endif %};"
                                {% if count > 0 %}title="{% for cr in cell_risks %}{{ cr.risk_ref }}: {{ cr.title }}&#10;{% endfor %}"{% endif %}>
                                {% if count > 0 %}
                                <span style="font-weight:700;font-size:0.85rem;color:#fff;">{{ count }}</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        <tr>
                            <td></td>
                            {% for impact in [1, 2, 3, 4, 5] %}
                            <td style="font-size:0.6rem;text-align:center;color:#6b7280;">{{ impact }}</td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
                <div class="d-flex justify-content-between mt-1 px-3">
                    <small class="text-muted" style="font-size:0.6rem;">Likelihood &uarr;</small>
                    <small class="text-muted" style="font-size:0.6rem;">Impact &rarr;</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
