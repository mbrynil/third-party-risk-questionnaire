{% extends "base.html" %}

{% block title %}Reassessment Calendar - RiskQ{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active">Reassessment Calendar</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-calendar3 me-2"></i>Reassessment Calendar</h1>
    <p class="text-muted">Upcoming vendor review dates grouped by month</p>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="fs-3 fw-bold text-primary">{{ total }}</div>
                <div class="text-muted small">Total Scheduled</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="fs-3 fw-bold text-danger">{{ overdue_count }}</div>
                <div class="text-muted small">Overdue</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="fs-3 fw-bold text-warning">{{ this_month }}</div>
                <div class="text-muted small">Due This Month</div>
            </div>
        </div>
    </div>
</div>

<div class="mb-3 d-flex gap-2 flex-wrap" id="calendarFilters">
    <select class="form-select form-select-sm" style="width:auto;" id="filterTier">
        <option value="">All Tiers</option>
        <option value="Tier 1">Tier 1</option>
        <option value="Tier 2">Tier 2</option>
        <option value="Tier 3">Tier 3</option>
    </select>
    <button class="btn btn-sm btn-outline-danger" id="filterOverdue">Overdue Only</button>
</div>

{% if months %}
{% for month in months %}
<div class="card mb-3 calendar-month" data-month="{{ month }}">
    <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-calendar-month me-2"></i>{{ month }}</h6>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Vendor</th>
                    <th>Tier</th>
                    <th>Risk Rating</th>
                    <th>Review Date</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in by_month[month] %}
                <tr class="calendar-row" data-tier="{{ item.tier or '' }}" data-overdue="{{ 'true' if item.overdue else 'false' }}">
                    <td>
                        <a href="/vendors/{{ item.vendor.id }}" class="text-decoration-none fw-semibold">{{ item.vendor.name }}</a>
                    </td>
                    <td>
                        {% if item.tier %}
                        <span class="badge" style="background:{{ tier_colors.get(item.tier, '#6c757d') }};color:#fff;">{{ item.tier }}</span>
                        {% else %}
                        <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.decision.overall_risk_rating %}
                        {% set rr = item.decision.overall_risk_rating %}
                        <span class="badge bg-{% if rr in ('VERY_LOW','LOW') %}success{% elif rr == 'MODERATE' %}warning text-dark{% else %}danger{% endif %}">
                            {{ rr.replace('_',' ').title() }}
                        </span>
                        {% else %}—{% endif %}
                    </td>
                    <td>{{ item.decision.next_review_date.strftime('%Y-%m-%d') }}</td>
                    <td>
                        {% if item.overdue %}
                        <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Overdue</span>
                        {% else %}
                        <span class="badge bg-success">Upcoming</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <a href="/vendors/{{ item.vendor.id }}" class="btn btn-sm btn-outline-primary">View Vendor</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endfor %}
{% else %}
<div class="card">
    <div class="card-body text-center py-5 text-muted">
        <i class="bi bi-calendar3" style="font-size:2rem;"></i>
        <p class="mt-2">No reassessment dates scheduled yet. Finalize assessments with a next review date to see them here.</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('filterTier').addEventListener('change', function() {
    var tier = this.value;
    document.querySelectorAll('.calendar-row').forEach(function(row) {
        if (!tier || row.dataset.tier === tier) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
var overdueBtn = document.getElementById('filterOverdue');
var overdueActive = false;
overdueBtn.addEventListener('click', function() {
    overdueActive = !overdueActive;
    this.classList.toggle('active');
    this.classList.toggle('btn-danger', overdueActive);
    this.classList.toggle('btn-outline-danger', !overdueActive);
    document.querySelectorAll('.calendar-row').forEach(function(row) {
        if (overdueActive && row.dataset.overdue !== 'true') {
            row.style.display = 'none';
        } else {
            row.style.display = '';
        }
    });
});
</script>
{% endblock %}
