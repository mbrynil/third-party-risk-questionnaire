{% extends "base.html" %}
{% set is_editable = test.status == TEST_STATUS_IN_PROGRESS %}

{% block title %}{% if is_editable %}Test Workspace{% else %}Test Workpaper{% endif %} — {{ test.implementation.control.control_ref }}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
{% if test.implementation.vendor %}
<li class="breadcrumb-item"><a href="/vendors/{{ test.implementation.vendor.id }}">{{ test.implementation.vendor.name }}</a></li>
<li class="breadcrumb-item"><a href="/vendors/{{ test.implementation.vendor.id }}/controls">Controls</a></li>
{% endif %}
<li class="breadcrumb-item"><a href="/controls/implementations/{{ test.implementation.id }}">{{ test.implementation.control.control_ref }}</a></li>
<li class="breadcrumb-item active">{% if is_editable %}Test Workspace{% else %}Test Workpaper{% endif %}</li>
{% endblock %}

{% block content %}
{% set message = request.query_params.get('message', '') %}
{% if message %}
<div class="alert alert-{{ request.query_params.get('message_type', 'info') }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{# ===== Header ===== #}
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h3 class="mb-1">
            <i class="bi bi-clipboard-check me-2"></i>
            {{ test.implementation.control.control_ref }} — {{ test.implementation.control.title }}
        </h3>
        <div class="d-flex gap-2 align-items-center mt-2">
            <span class="badge" style="background-color:{{ test_status_colors.get(test.status, '#6c757d') }};font-size:0.85rem;">{{ test_status_labels.get(test.status, test.status) }}</span>
            <span class="badge bg-secondary" style="font-size:0.85rem;">{{ test_type_labels.get(test.test_type, test.test_type) }}</span>
            {% if test.status == TEST_STATUS_COMPLETED %}
            <span class="badge" style="background-color:{{ test_result_colors.get(test.result, '#6c757d') }};font-size:0.85rem;">{{ test_result_labels.get(test.result, test.result) }}</span>
            {% endif %}
            {% if test.finding_risk_rating %}
            <span class="badge" style="background-color:{{ finding_risk_colors.get(test.finding_risk_rating, '#6c757d') }};font-size:0.85rem;">Finding: {{ finding_risk_labels.get(test.finding_risk_rating, test.finding_risk_rating) }}</span>
            {% endif %}
            {% if test.reviewer %}
            <span class="badge bg-success" style="font-size:0.85rem;"><i class="bi bi-check-circle me-1"></i>Reviewed</span>
            {% endif %}
        </div>
    </div>
    <div class="d-flex gap-2">
        {% if test.status == TEST_STATUS_COMPLETED %}
        <a href="/controls/tests/{{ test.id }}/export.pdf" class="btn btn-outline-primary"><i class="bi bi-file-earmark-pdf me-1"></i>Export PDF</a>
        <form method="post" action="/controls/tests/{{ test.id }}/roll-forward" class="d-inline">
            <button type="submit" class="btn btn-outline-secondary"><i class="bi bi-arrow-repeat me-1"></i>Roll Forward</button>
        </form>
        {% if next_impl %}
        <a href="/controls/implementations/{{ next_impl.id }}" class="btn btn-outline-info" title="Next control due for testing"><i class="bi bi-skip-forward me-1"></i>Next: {{ next_impl.control.control_ref }}</a>
        {% endif %}
        {% endif %}
        <a href="/controls/implementations/{{ test.implementation.id }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>Back</a>
    </div>
</div>

{# SoD Warning Banners #}
{% if sod_tester_is_owner %}
<div class="alert alert-warning d-flex align-items-center mb-3">
    <i class="bi bi-exclamation-triangle me-2"></i>
    SoD Warning: The tester is also the control owner. Consider assigning a different tester for independence.
</div>
{% endif %}
{% if sod_reviewer_is_tester %}
<div class="alert alert-warning d-flex align-items-center mb-3">
    <i class="bi bi-exclamation-triangle me-2"></i>
    SoD Warning: The reviewer is the same person as the tester. Consider having a different person review.
</div>
{% endif %}


{% if is_editable %}
{# ============================================================ #}
{# ===== EDITABLE WORKSPACE (IN_PROGRESS) ===== #}
{# ============================================================ #}

{% if test.is_roll_forward %}
<div class="alert alert-info d-flex align-items-center mb-3">
    <i class="bi bi-arrow-repeat me-2 fs-5"></i>
    This is a roll-forward test, based on test <a href="/controls/tests/{{ test.parent_test_id }}">#{{ test.parent_test_id }}</a>. Prior workpaper has been pre-filled — review and update as needed.
</div>
{% endif %}

<form method="post" action="/controls/tests/{{ test.id }}/save" enctype="multipart/form-data">
<div class="row g-4">
    <div class="col-lg-8">

        {# ===== Section 1: Test Setup ===== #}
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><span class="badge bg-primary rounded-pill me-2">1</span>Test Setup</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Test Type <span class="text-danger">*</span></label>
                        <select name="test_type" class="form-select">
                            {% for t in test_types %}
                            <option value="{{ t }}" {% if test.test_type == t %}selected{% endif %}>{{ test_type_labels[t] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Result</label>
                        <select name="result" class="form-select">
                            {% for r in test_results %}
                            <option value="{{ r }}" {% if test.result == r %}selected{% endif %}>{{ test_result_labels[r] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        {# ===== Section 2: Scope & Sampling ===== #}
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><span class="badge bg-primary rounded-pill me-2">2</span>Scope & Sampling</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Test Period Start</label>
                        <input type="date" name="test_period_start" class="form-control" value="{{ test.test_period_start.strftime('%Y-%m-%d') if test.test_period_start else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Test Period End</label>
                        <input type="date" name="test_period_end" class="form-control" value="{{ test.test_period_end.strftime('%Y-%m-%d') if test.test_period_end else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Population Size</label>
                        <input type="number" name="population_size" class="form-control" min="0" value="{{ test.population_size if test.population_size is not none else '' }}" placeholder="Total items in population">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sample Size</label>
                        <input type="number" name="sample_size" class="form-control" min="0" value="{{ test.sample_size if test.sample_size is not none else '' }}" placeholder="Items tested">
                    </div>
                </div>
            </div>
        </div>

        {# ===== Section 3: Test Procedure ===== #}
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><span class="badge bg-primary rounded-pill me-2">3</span>Test Procedure</h6>
            </div>
            <div class="card-body">
                <textarea name="test_procedure" class="form-control" rows="5" placeholder="Describe the test procedure — steps taken, criteria evaluated, tools used...">{{ test.test_procedure or '' }}</textarea>
            </div>
        </div>

        {# ===== Section 4: Results ===== #}
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><span class="badge bg-primary rounded-pill me-2">4</span>Results</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Exceptions Found</label>
                        <input type="number" name="exceptions_count" id="exceptions_count" class="form-control" min="0" value="{{ test.exceptions_count if test.exceptions_count is not none else 0 }}" onchange="toggleExceptionDetails()">
                    </div>
                    <div class="col-md-6">&nbsp;</div>
                    <div class="col-12" id="exception_details_group">
                        <label class="form-label">Exception Details</label>
                        <textarea name="exception_details" class="form-control" rows="3" placeholder="Describe each exception — item reference, nature of deviation, root cause...">{{ test.exception_details or '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        {# ===== Section 5: Findings & Conclusion ===== #}
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><span class="badge bg-primary rounded-pill me-2">5</span>Findings & Conclusion</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Findings</label>
                        <textarea name="findings" class="form-control" rows="3" placeholder="Document findings from the test...">{{ test.findings or '' }}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Recommendations</label>
                        <textarea name="recommendations" class="form-control" rows="2" placeholder="Recommendations for improvement or remediation...">{{ test.recommendations or '' }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Finding Risk Rating</label>
                        <select name="finding_risk_rating" class="form-select">
                            <option value="">— Select —</option>
                            {% for fr in finding_risk_ratings %}
                            <option value="{{ fr }}" {% if test.finding_risk_rating == fr %}selected{% endif %}>{{ finding_risk_labels[fr] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Conclusion</label>
                        <textarea name="conclusion" class="form-control" rows="3" placeholder="Overall test conclusion — summarize whether the control is operating effectively...">{{ test.conclusion or '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        {# ===== Section 6: Evidence ===== #}
        <div class="card mb-3">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><span class="badge bg-primary rounded-pill me-2">6</span>Evidence <span class="badge bg-secondary ms-1">{{ test.evidence_files|length }}</span></h6>
            </div>
            {% if test.evidence_files %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>File</th><th>Size</th><th>Uploaded</th><th class="text-end">Actions</th></tr></thead>
                    <tbody>
                        {% for ev in test.evidence_files %}
                        <tr>
                            <td><i class="bi bi-file-earmark me-1"></i>{{ ev.original_filename }}</td>
                            <td><small class="text-muted">{% if ev.size_bytes %}{{ (ev.size_bytes / 1024)|round(1) }} KB{% endif %}</small></td>
                            <td><small class="text-muted">{{ ev.uploaded_at.strftime('%Y-%m-%d') if ev.uploaded_at else '' }}</small></td>
                            <td class="text-end">
                                <a href="/controls/evidence/{{ ev.id }}/download" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i></a>
                                <form method="post" action="/controls/evidence/{{ ev.id }}/delete" class="d-inline" onsubmit="return confirm('Delete this file?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            <div class="card-body {% if test.evidence_files %}pt-2{% endif %}">
                <label class="form-label small text-muted">Attach additional evidence</label>
                <input type="file" name="evidence_files" class="form-control form-control-sm" multiple>
                {% if test.implementation.control.evidence_instructions %}
                <div class="alert alert-light border mt-2">
                    <strong><i class="bi bi-info-circle me-1"></i>Evidence Collection Guide:</strong>
                    <p class="mb-0 mt-1"><small>{{ test.implementation.control.evidence_instructions }}</small></p>
                </div>
                {% endif %}
            </div>
        </div>

        {# ===== Action Buttons ===== #}
        <div class="d-flex gap-2 mb-4">
            <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Save Progress</button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#finalizeModal"><i class="bi bi-check-circle me-1"></i>Finalize Test</button>
        </div>
    </div>{# /col-lg-8 #}

    {# ===== Sidebar ===== #}
    <div class="col-lg-4">
        {# Control Info #}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>Control</h6></div>
            <div class="card-body">
                <p class="fw-semibold mb-1">{{ test.implementation.control.control_ref }}</p>
                <p class="mb-2">{{ test.implementation.control.title }}</p>
                {% if test.implementation.vendor %}
                <p class="text-muted mb-1"><small>Vendor: {{ test.implementation.vendor.name }}</small></p>
                {% endif %}
                {% if test.implementation.control.owner %}
                <p class="text-muted mb-1"><small>Owner: {{ test.implementation.control.owner.display_name }}</small></p>
                {% endif %}
                <div class="mt-2">
                    {% for m in test.implementation.control.framework_mappings %}
                    <span class="badge bg-light text-dark border" style="font-size:0.7rem;">{{ framework_display.get(m.framework, m.framework) }}: {{ m.reference }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# Workspace Info #}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Workspace</h6></div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="text-muted small text-uppercase">Tester</label>
                    <p class="fw-semibold mb-0">{{ test.tester.display_name if test.tester else '—' }}</p>
                </div>
                <div class="mb-2">
                    <label class="text-muted small text-uppercase">Created</label>
                    <p class="fw-semibold mb-0">{{ test.created_at.strftime('%Y-%m-%d %H:%M') if test.created_at else '—' }}</p>
                </div>
                {% if test.scheduled_date %}
                <div>
                    <label class="text-muted small text-uppercase">Originally Scheduled</label>
                    <p class="fw-semibold mb-0">{{ test.scheduled_date.strftime('%Y-%m-%d') }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card border-info mb-3">
            <div class="card-body text-center py-3">
                <i class="bi bi-pencil-square text-info" style="font-size:1.5rem;"></i>
                <p class="mb-0 mt-2 small text-muted">This test is <strong>in progress</strong>. Save your work as you go. When you're done, click <strong>Finalize Test</strong> to lock it down.</p>
            </div>
        </div>
    </div>{# /col-lg-4 #}
</div>{# /row #}
</form>{# /main save form #}

{# ===== Section 7: Findings (outside main form to avoid nested forms) ===== #}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-3" id="findings">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><span class="badge bg-primary rounded-pill me-2">7</span>Findings <span class="badge bg-secondary ms-1">{{ test_findings|length if test_findings else 0 }}</span></h6>
            </div>
            <div class="card-body">
                {% if test_findings %}
                <div class="table-responsive mb-3">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>Condition</th>
                                <th>Status</th>
                                <th>Owner</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in test_findings %}
                            <tr>
                                <td><span class="badge bg-info">{{ finding_type_labels.get(f.finding_type, f.finding_type) if finding_type_labels else f.finding_type }}</span></td>
                                <td><span class="badge bg-warning text-dark">{{ f.severity }}</span></td>
                                <td><small>{{ f.condition[:80] }}{% if f.condition|length > 80 %}...{% endif %}</small></td>
                                <td><span class="badge" style="background-color:{{ finding_status_colors.get(f.status, '#6c757d') if finding_status_colors else '#6c757d' }};">{{ finding_status_labels.get(f.status, f.status) if finding_status_labels else f.status }}</span></td>
                                <td><small>{{ f.owner.display_name if f.owner else '—' }}</small></td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Update</button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            {% for s in finding_statuses %}
                                            {% if s != f.status %}
                                            <li>
                                                <form method="post" action="/controls/findings/{{ f.id }}/update" class="d-inline">
                                                    <input type="hidden" name="status" value="{{ s }}">
                                                    <button type="submit" class="dropdown-item">{{ finding_status_labels.get(s, s) if finding_status_labels else s }}</button>
                                                </form>
                                            </li>
                                            {% endif %}
                                            {% endfor %}
                                        </ul>
                                        <form method="post" action="/controls/findings/{{ f.id }}/close" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Close this finding?')"><i class="bi bi-x-circle"></i></button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <h6 class="mb-3"><i class="bi bi-plus-circle me-1"></i>Add Finding</h6>
                <form method="post" action="/controls/tests/{{ test.id }}/findings">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small">Finding Type</label>
                            <select name="finding_type" class="form-select form-select-sm" required>
                                <option value="">-- Select --</option>
                                {% for ft in finding_types %}
                                <option value="{{ ft }}">{{ finding_type_labels.get(ft, ft) if finding_type_labels else ft }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Severity</label>
                            <select name="severity" class="form-select form-select-sm" required>
                                <option value="">-- Select --</option>
                                {% for sev in severities %}
                                <option value="{{ sev }}">{{ sev }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Criteria</label>
                            <textarea name="criteria" class="form-control form-control-sm" rows="2" placeholder="What the control should do..."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Condition</label>
                            <textarea name="condition" class="form-control form-control-sm" rows="2" placeholder="What was actually observed..." required></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Cause</label>
                            <textarea name="cause" class="form-control form-control-sm" rows="2" placeholder="Root cause of the finding..."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Effect</label>
                            <textarea name="effect" class="form-control form-control-sm" rows="2" placeholder="Impact or effect of the finding..."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label small">Recommendation</label>
                            <textarea name="recommendation" class="form-control form-control-sm" rows="2" placeholder="Recommended remediation..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Owner</label>
                            <select name="owner_user_id" class="form-select form-select-sm">
                                <option value="">-- Select --</option>
                                {% for u in users %}
                                <option value="{{ u.id }}">{{ u.display_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Due Date</label>
                            <input type="date" name="due_date" class="form-control form-control-sm">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle me-1"></i>Add Finding</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>{# /findings row #}

{# Finalize Confirmation Modal #}
<div class="modal fade" id="finalizeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Finalize Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Finalizing this test will:</p>
                <ul>
                    <li>Set the test date to now</li>
                    <li>Lock the workpaper (read-only)</li>
                    <li>Update the next test due date for this control</li>
                </ul>
                <p class="mb-0 text-muted small">Make sure you've saved your latest changes before finalizing.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="/controls/tests/{{ test.id }}/finalize" class="d-inline">
                    <button type="submit" class="btn btn-success"><i class="bi bi-check-circle me-1"></i>Finalize Test</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function toggleExceptionDetails() {
    var count = parseInt(document.getElementById('exceptions_count').value) || 0;
    document.getElementById('exception_details_group').style.display = count > 0 ? 'block' : 'none';
}
toggleExceptionDetails();
</script>


{% else %}
{# ============================================================ #}
{# ===== READ-ONLY WORKPAPER (COMPLETED) ===== #}
{# ============================================================ #}

{# Roll-Forward Banner #}
{% if test.is_roll_forward %}
<div class="alert alert-info d-flex align-items-center mb-3">
    <i class="bi bi-arrow-repeat me-2"></i>
    This is a roll-forward test, based on test <a href="/controls/tests/{{ test.parent_test_id }}">#{{ test.parent_test_id }}</a>.
</div>
{% endif %}

{# ===== Metadata Grid ===== #}
<div class="card mb-4">
    <div class="card-body p-3">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="text-muted small text-uppercase">Test Date</label>
                <p class="fw-semibold mb-0">{{ test.test_date.strftime('%Y-%m-%d %H:%M') if test.test_date else '—' }}</p>
            </div>
            <div class="col-md-3">
                <label class="text-muted small text-uppercase">Test Type</label>
                <p class="mb-0"><span class="badge bg-secondary">{{ test_type_labels.get(test.test_type, test.test_type) }}</span></p>
            </div>
            <div class="col-md-3">
                <label class="text-muted small text-uppercase">Result</label>
                <p class="mb-0"><span class="badge" style="background-color:{{ test_result_colors.get(test.result, '#6c757d') }};">{{ test_result_labels.get(test.result, test.result) }}</span></p>
            </div>
            <div class="col-md-3">
                <label class="text-muted small text-uppercase">Finding Risk</label>
                <p class="mb-0">
                    {% if test.finding_risk_rating %}
                    <span class="badge" style="background-color:{{ finding_risk_colors.get(test.finding_risk_rating, '#6c757d') }};">{{ finding_risk_labels.get(test.finding_risk_rating, test.finding_risk_rating) }}</span>
                    {% else %}—{% endif %}
                </p>
            </div>
        </div>
        <hr class="my-3">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="text-muted small text-uppercase">Test Period</label>
                <p class="fw-semibold mb-0">
                    {% if test.test_period_start or test.test_period_end %}
                    {{ test.test_period_start.strftime('%Y-%m-%d') if test.test_period_start else '?' }} — {{ test.test_period_end.strftime('%Y-%m-%d') if test.test_period_end else '?' }}
                    {% else %}—{% endif %}
                </p>
            </div>
            <div class="col-md-3">
                <label class="text-muted small text-uppercase">Sample</label>
                <p class="fw-semibold mb-0">
                    {% if test.sample_size is not none or test.population_size is not none %}
                    {{ test.sample_size if test.sample_size is not none else '?' }} of {{ test.population_size if test.population_size is not none else '?' }}
                    {% else %}—{% endif %}
                </p>
            </div>
            <div class="col-md-3">
                <label class="text-muted small text-uppercase">Exceptions</label>
                <p class="fw-semibold mb-0">{{ test.exceptions_count if test.exceptions_count is not none else '—' }}</p>
            </div>
            <div class="col-md-3">
                <label class="text-muted small text-uppercase">Tester</label>
                <p class="fw-semibold mb-0">{{ test.tester.display_name if test.tester else '—' }}</p>
            </div>
        </div>
    </div>
</div>

{# ===== Long-form Sections ===== #}
<div class="row g-4">
    <div class="col-lg-8">

        {% if test.test_procedure %}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-list-check me-2"></i>Test Procedure</h6></div>
            <div class="card-body">
                <div class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ test.test_procedure }}</div>
            </div>
        </div>
        {% endif %}

        {% if test.findings %}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-search me-2"></i>Findings</h6>
                {% if test.finding_risk_rating %}
                <span class="badge" style="background-color:{{ finding_risk_colors.get(test.finding_risk_rating, '#6c757d') }};">{{ finding_risk_labels.get(test.finding_risk_rating, test.finding_risk_rating) }}</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ test.findings }}</div>
            </div>
        </div>
        {% endif %}

        {% if test.exceptions_count and test.exceptions_count > 0 and test.exception_details %}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-exclamation-circle me-2"></i>Exception Details <span class="badge bg-danger ms-1">{{ test.exceptions_count }}</span></h6></div>
            <div class="card-body">
                <div class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ test.exception_details }}</div>
            </div>
        </div>
        {% endif %}

        {% if test.recommendations %}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Recommendations</h6></div>
            <div class="card-body">
                <div class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ test.recommendations }}</div>
            </div>
        </div>
        {% endif %}

        {% if test.conclusion %}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-check2-square me-2"></i>Conclusion</h6></div>
            <div class="card-body">
                <div class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ test.conclusion }}</div>
            </div>
        </div>
        {% endif %}

        {# ===== Evidence Files ===== #}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-paperclip me-2"></i>Evidence Files <span class="badge bg-secondary ms-1">{{ test.evidence_files|length }}</span></h6>
            </div>
            {% if test.evidence_files %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>File</th><th>Size</th><th>Uploaded</th><th class="text-end">Actions</th></tr></thead>
                    <tbody>
                        {% for ev in test.evidence_files %}
                        <tr>
                            <td><i class="bi bi-file-earmark me-1"></i>{{ ev.original_filename }}</td>
                            <td><small class="text-muted">{% if ev.size_bytes %}{{ (ev.size_bytes / 1024)|round(1) }} KB{% endif %}</small></td>
                            <td><small class="text-muted">{{ ev.uploaded_at.strftime('%Y-%m-%d') if ev.uploaded_at else '' }}</small></td>
                            <td class="text-end">
                                <a href="/controls/evidence/{{ ev.id }}/download" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i></a>
                                <form method="post" action="/controls/evidence/{{ ev.id }}/delete" class="d-inline" onsubmit="return confirm('Delete this file?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card-body text-muted">No evidence files attached.</div>
            {% endif %}
            <div class="card-footer">
                <form method="post" action="/controls/tests/{{ test.id }}/evidence" enctype="multipart/form-data" class="d-flex gap-2">
                    <input type="file" name="evidence_files" class="form-control form-control-sm" multiple>
                    <button type="submit" class="btn btn-sm btn-outline-primary"><i class="bi bi-upload me-1"></i>Upload</button>
                </form>
                {% if test.implementation.control.evidence_instructions %}
                <div class="alert alert-light border mt-2">
                    <strong><i class="bi bi-info-circle me-1"></i>Evidence Collection Guide:</strong>
                    <p class="mb-0 mt-1"><small>{{ test.implementation.control.evidence_instructions }}</small></p>
                </div>
                {% endif %}
            </div>
        </div>

        {# ===== Findings Section ===== #}
        <div class="card mb-3" id="findings">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-flag me-2"></i>Findings <span class="badge bg-secondary ms-1">{{ test_findings|length if test_findings else 0 }}</span></h6>
            </div>
            <div class="card-body">
                {% if test_findings %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>Condition</th>
                                <th>Status</th>
                                <th>Owner</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in test_findings %}
                            <tr>
                                <td><span class="badge bg-info">{{ finding_type_labels.get(f.finding_type, f.finding_type) if finding_type_labels else f.finding_type }}</span></td>
                                <td><span class="badge bg-warning text-dark">{{ f.severity }}</span></td>
                                <td><small>{{ f.condition[:80] }}{% if f.condition|length > 80 %}...{% endif %}</small></td>
                                <td><span class="badge" style="background-color:{{ finding_status_colors.get(f.status, '#6c757d') if finding_status_colors else '#6c757d' }};">{{ finding_status_labels.get(f.status, f.status) if finding_status_labels else f.status }}</span></td>
                                <td><small>{{ f.owner.display_name if f.owner else '—' }}</small></td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Update</button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            {% for s in finding_statuses %}
                                            {% if s != f.status %}
                                            <li>
                                                <form method="post" action="/controls/findings/{{ f.id }}/update" class="d-inline">
                                                    <input type="hidden" name="status" value="{{ s }}">
                                                    <button type="submit" class="dropdown-item">{{ finding_status_labels.get(s, s) if finding_status_labels else s }}</button>
                                                </form>
                                            </li>
                                            {% endif %}
                                            {% endfor %}
                                        </ul>
                                        <form method="post" action="/controls/findings/{{ f.id }}/close" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Close this finding?')"><i class="bi bi-x-circle"></i></button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No findings recorded.</p>
                {% endif %}

                <hr class="my-3">
                <p class="mb-2">
                    <a class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" href="#addFindingCollapse" role="button" aria-expanded="false" aria-controls="addFindingCollapse">
                        <i class="bi bi-plus-circle me-1"></i>Add Finding
                    </a>
                </p>
                <div class="collapse" id="addFindingCollapse">
                    <form method="post" action="/controls/tests/{{ test.id }}/findings">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small">Finding Type</label>
                                <select name="finding_type" class="form-select form-select-sm" required>
                                    <option value="">-- Select --</option>
                                    {% for ft in finding_types %}
                                    <option value="{{ ft }}">{{ finding_type_labels.get(ft, ft) if finding_type_labels else ft }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Severity</label>
                                <select name="severity" class="form-select form-select-sm" required>
                                    <option value="">-- Select --</option>
                                    {% for sev in severities %}
                                    <option value="{{ sev }}">{{ sev }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label small">Criteria</label>
                                <textarea name="criteria" class="form-control form-control-sm" rows="2" placeholder="What the control should do..."></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label small">Condition</label>
                                <textarea name="condition" class="form-control form-control-sm" rows="2" placeholder="What was actually observed..." required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label small">Cause</label>
                                <textarea name="cause" class="form-control form-control-sm" rows="2" placeholder="Root cause of the finding..."></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label small">Effect</label>
                                <textarea name="effect" class="form-control form-control-sm" rows="2" placeholder="Impact or effect of the finding..."></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label small">Recommendation</label>
                                <textarea name="recommendation" class="form-control form-control-sm" rows="2" placeholder="Recommended remediation..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Owner</label>
                                <select name="owner_user_id" class="form-select form-select-sm">
                                    <option value="">-- Select --</option>
                                    {% for u in users %}
                                    <option value="{{ u.id }}">{{ u.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Due Date</label>
                                <input type="date" name="due_date" class="form-control form-control-sm">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle me-1"></i>Add Finding</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    {# ===== Sidebar ===== #}
    <div class="col-lg-4">

        {# Control Info #}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>Control</h6></div>
            <div class="card-body">
                <p class="fw-semibold mb-1">{{ test.implementation.control.control_ref }}</p>
                <p class="mb-2">{{ test.implementation.control.title }}</p>
                {% if test.implementation.vendor %}
                <p class="text-muted mb-1"><small>Vendor: {{ test.implementation.vendor.name }}</small></p>
                {% endif %}
                {% if test.implementation.control.owner %}
                <p class="text-muted mb-1"><small>Owner: {{ test.implementation.control.owner.display_name }}</small></p>
                {% endif %}
                <div class="mt-2">
                    {% for m in test.implementation.control.framework_mappings %}
                    <span class="badge bg-light text-dark border" style="font-size:0.7rem;">{{ framework_display.get(m.framework, m.framework) }}: {{ m.reference }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# Reviewer Sign-Off #}
        <div class="card mb-3">
            <div class="card-header"><h6 class="mb-0"><i class="bi bi-pen me-2"></i>Reviewer Sign-Off</h6></div>
            <div class="card-body">
                {% if test.reviewer %}
                <div class="mb-2">
                    <label class="text-muted small text-uppercase">Reviewer</label>
                    <p class="fw-semibold mb-0">{{ test.reviewer.display_name }}</p>
                </div>
                <div class="mb-2">
                    <label class="text-muted small text-uppercase">Review Date</label>
                    <p class="fw-semibold mb-0">{{ test.review_date.strftime('%Y-%m-%d %H:%M') if test.review_date else '—' }}</p>
                </div>
                {% if test.review_notes %}
                <div>
                    <label class="text-muted small text-uppercase">Review Notes</label>
                    <div class="bg-light p-2 rounded small" style="white-space: pre-wrap;">{{ test.review_notes }}</div>
                </div>
                {% endif %}
                {% else %}
                {# SoD Warning #}
                {% if test.tester and current_user and test.tester.id == current_user.id %}
                <div class="alert alert-warning py-2 px-3 mb-3 small">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    You are the tester for this workpaper. A different reviewer is recommended for separation of duties.
                </div>
                {% endif %}
                <form method="post" action="/controls/tests/{{ test.id }}/review">
                    <div class="mb-3">
                        <label class="form-label small">Review Notes</label>
                        <textarea name="review_notes" class="form-control form-control-sm" rows="3" placeholder="Optional review notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-sm btn-success w-100"><i class="bi bi-check-circle me-1"></i>Sign Off</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}
