{% extends "base.html" %}

{% block title %}Vendors - RiskQ{% endblock %}

{% block extra_head %}
<style>
    .tier-badge-sm {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.7rem;
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
    <div>
        <h1>Vendors</h1>
        <p>Manage your third-party vendors and their assessments</p>
    </div>
    <div class="mt-3 mt-sm-0">
        <a href="/vendors/new" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i>Add Vendor
        </a>
    </div>
</div>

{% if request.query_params.get('created') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle me-2"></i>Vendor created successfully!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if request.query_params.get('updated') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle me-2"></i>Vendor updated successfully!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if vendors %}
<div class="card">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Vendor</th>
                    <th>Tier</th>
                    <th>Status</th>
                    <th>Assessments</th>
                    <th>Last Assessed</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for vendor in vendors %}
                {% set tier_colors = {"Tier 1": "#dc3545", "Tier 2": "#fd7e14", "Tier 3": "#198754"} %}
                <tr>
                    <td>
                        <div class="fw-semibold">{{ vendor.name }}</div>
                        {% if vendor.industry or vendor.service_type %}
                        <small class="text-muted">
                            {% if vendor.industry %}{{ vendor.industry }}{% endif %}
                            {% if vendor.industry and vendor.service_type %} &middot; {% endif %}
                            {% if vendor.service_type %}{{ vendor.service_type }}{% endif %}
                        </small>
                        {% elif vendor.primary_contact_name or vendor.primary_contact_email %}
                        <small class="text-muted">
                            {% if vendor.primary_contact_name %}{{ vendor.primary_contact_name }}{% endif %}
                            {% if vendor.primary_contact_name and vendor.primary_contact_email %} &middot; {% endif %}
                            {% if vendor.primary_contact_email %}{{ vendor.primary_contact_email }}{% endif %}
                        </small>
                        {% endif %}
                    </td>
                    <td>
                        {% set eff_tier = vendor.tier_override or vendor.inherent_risk_tier %}
                        {% if eff_tier %}
                        <span class="tier-badge-sm" style="background: {{ tier_colors.get(eff_tier, '#6c757d') }};">{{ eff_tier }}</span>
                        {% else %}
                        <span class="text-muted">&mdash;</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if vendor.status == 'ACTIVE' %}
                        <span class="badge bg-success-subtle text-success border border-success-subtle">Active</span>
                        {% else %}
                        <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">Archived</span>
                        {% endif %}
                    </td>
                    <td>{{ vendor.assessments|length }}</td>
                    <td>
                        {% set last_submitted = namespace(date=None) %}
                        {% for q in vendor.assessments %}
                            {% for r in q.responses %}
                                {% if r.status == 'SUBMITTED' and r.submitted_at %}
                                    {% if not last_submitted.date or r.submitted_at > last_submitted.date %}
                                        {% set last_submitted.date = r.submitted_at %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        {% if last_submitted.date %}
                            {{ last_submitted.date.strftime('%Y-%m-%d') }}
                        {% else %}
                            <span class="text-muted">&mdash;</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <a href="/vendors/{{ vendor.id }}" class="btn btn-sm btn-outline-secondary">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-building text-muted" style="font-size: 3rem;"></i>
        <h5 class="mt-4">No vendors yet</h5>
        <p class="text-muted">Get started by adding your first vendor.</p>
        <a href="/vendors/new" class="btn btn-primary mt-2">
            <i class="bi bi-plus-lg me-2"></i>Add Vendor
        </a>
    </div>
</div>
{% endif %}
{% endblock %}
