{% extends "base.html" %}

{% block title %}Control Testing - RiskQ{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
<li class="breadcrumb-item"><a href="/controls">Controls</a></li>
<li class="breadcrumb-item active">Control Testing</li>
{% endblock %}

{% block extra_head %}
<style>
    .tracker-filters select { min-width: 130px; }
    .status-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .status-overdue { background: #fee2e2; color: #991b1b; }
    .status-upcoming { background: #fef3c7; color: #92400e; }
    .status-on-track { background: #d1fae5; color: #065f46; }
    .status-never { background: #f3f4f6; color: #6b7280; }
    .status-scheduled { background: #e0e7ff; color: #3730a3; }
    .kpi-card { text-align: center; }
    .kpi-card .kpi-value { font-size: 1.75rem; font-weight: 700; line-height: 1.2; }
    .kpi-card .kpi-label { font-size: 0.8rem; color: #6b7280; }
    .nav-tabs .nav-link { font-weight: 500; }
    .nav-tabs .nav-link.active { border-bottom: 2px solid #2563eb; font-weight: 600; }
</style>
{% endblock %}

{% block content %}
{% set message = request.query_params.get('message', '') %}
{% if message %}
<div class="alert alert-{{ request.query_params.get('message_type', 'info') }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-start">
    <div>
        <h1><i class="bi bi-clipboard-check me-2"></i>Control Testing</h1>
        <p>Central hub for all control testing activity &mdash; schedule, overdue items, and completed tests</p>
    </div>
    <div class="d-flex gap-2">
        <a href="/controls/testing/export.csv" class="btn btn-outline-success btn-sm">
            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Export CSV
        </a>
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#scheduleTestModal">
            <i class="bi bi-calendar-plus me-1"></i>Schedule Test
        </button>
        <a href="/controls/dashboard" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-shield-check me-1"></i>Dashboard
        </a>
        <a href="/controls" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-shield-lock me-1"></i>Library
        </a>
    </div>
</div>

<!-- KPI Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3 col-lg">
        <div class="card kpi-card {% if kpi_overdue > 0 %}border-danger{% endif %}">
            <div class="card-body py-3">
                <div class="kpi-value {% if kpi_overdue > 0 %}text-danger{% else %}text-success{% endif %}">{{ kpi_overdue }}</div>
                <div class="kpi-label">Overdue</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card kpi-card">
            <div class="card-body py-3">
                <div class="kpi-value text-warning">{{ kpi_upcoming }}</div>
                <div class="kpi-label">Due in 30 Days</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card kpi-card">
            <div class="card-body py-3">
                <div class="kpi-value" style="color:#4f46e5;">{{ kpi_scheduled }}</div>
                <div class="kpi-label">Scheduled</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card kpi-card {% if kpi_in_progress > 0 %}border-primary{% endif %}">
            <div class="card-body py-3">
                <div class="kpi-value text-primary">{{ kpi_in_progress }}</div>
                <div class="kpi-label">In Progress</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card kpi-card">
            <div class="card-body py-3">
                <div class="kpi-value" style="color:#198754;">{{ kpi_completed_month }}</div>
                <div class="kpi-label">Completed This Month</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card kpi-card">
            <div class="card-body py-3">
                <div class="kpi-value {% if kpi_pass_rate >= 80 %}text-success{% elif kpi_pass_rate >= 50 %}text-warning{% else %}text-danger{% endif %}">{{ kpi_pass_rate }}%</div>
                <div class="kpi-label">Pass Rate YTD</div>
            </div>
        </div>
    </div>
</div>

{# Bulk Schedule Floating Bar #}
<div id="bulkScheduleBar" class="card border-primary mb-3" style="display:none;position:sticky;top:60px;z-index:100;">
    <div class="card-body py-2">
        <form method="post" action="/controls/testing/bulk-schedule" id="bulkScheduleForm" class="d-flex align-items-center gap-3 flex-wrap">
            <span class="fw-semibold"><span id="schSelectedCount">0</span> selected</span>
            <input type="date" name="scheduled_date" class="form-control form-control-sm" style="width:160px;" required>
            <select name="test_type" class="form-select form-select-sm" style="width:140px;">
                {% for t in test_types %}
                <option value="{{ t }}">{{ test_type_labels[t] }}</option>
                {% endfor %}
            </select>
            <select name="tester_user_id" class="form-select form-select-sm" style="width:160px;">
                <option value="">-- Unassigned --</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.display_name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-calendar-plus me-1"></i>Schedule All</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearScheduleSelection()">Clear</button>
        </form>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-0" id="testingTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedulePane"
                type="button" role="tab">
            <i class="bi bi-calendar-event me-1"></i>Testing Schedule
            <span class="badge bg-secondary ms-1">{{ schedule_rows|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="inprogress-tab" data-bs-toggle="tab" data-bs-target="#inProgressPane"
                type="button" role="tab">
            <i class="bi bi-pencil-square me-1"></i>In Progress
            {% if in_progress_tests %}<span class="badge bg-primary ms-1">{{ in_progress_tests|length }}</span>{% endif %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#historyPane"
                type="button" role="tab">
            <i class="bi bi-clock-history me-1"></i>Test History
            <span class="badge bg-secondary ms-1">{{ test_history|length }}</span>
        </button>
    </li>
</ul>

<div class="tab-content">
    <!-- ==================== SCHEDULE TAB ==================== -->
    <div class="tab-pane fade show active" id="schedulePane" role="tabpanel">
        <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">

            {% if scheduled_tests %}
            <!-- Scheduled Tests Callout -->
            <div class="card-body border-bottom" style="background:#f5f3ff;">
                <h6 class="mb-2"><i class="bi bi-calendar-plus me-1" style="color:#4f46e5;"></i>Scheduled Tests <span class="badge" style="background:#4f46e5;">{{ scheduled_tests|length }}</span></h6>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Scheduled Date</th>
                                <th>Control</th>
                                <th>Type</th>
                                <th>Assigned Tester</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for st in scheduled_tests %}
                            <tr>
                                <td><span class="status-badge status-scheduled">{{ st.scheduled_date.strftime('%Y-%m-%d') if st.scheduled_date else 'â€”' }}</span></td>
                                <td>
                                    {% if st.implementation and st.implementation.control %}
                                    <a href="/controls/{{ st.implementation.control.id }}" class="text-decoration-none fw-semibold">{{ st.implementation.control.control_ref }}</a>
                                    <small class="text-muted ms-1">{{ st.implementation.control.title }}</small>
                                    {% endif %}
                                </td>
                                <td><small>{{ test_type_labels.get(st.test_type, st.test_type) }}</small></td>
                                <td>
                                    {% if st.tester %}<small>{{ st.tester.display_name }}</small>
                                    {% else %}<span class="text-muted">&mdash;</span>{% endif %}
                                </td>
                                <td class="text-end">
                                    <form method="post" action="/controls/tests/{{ st.id }}/start" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-primary" title="Start working this test">
                                            <i class="bi bi-play-circle me-1"></i>Start Test
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Schedule Filters -->
            <div class="card-body py-2 border-bottom">
                <div class="row g-2 align-items-center tracker-filters">
                    <div class="col-auto">
                        <i class="bi bi-funnel me-1 text-muted"></i>
                        <strong class="small text-muted">Filters:</strong>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="schFilterStatus" onchange="applyScheduleFilters()">
                            <option value="">All Statuses</option>
                            <option value="OVERDUE">Overdue</option>
                            <option value="UPCOMING">Due in 30 Days</option>
                            <option value="ON_TRACK">On Track</option>
                            <option value="NEVER_TESTED">Never Tested</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="schFilterDomain" onchange="applyScheduleFilters()">
                            <option value="">All Domains</option>
                            {% for d in domains %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="schFilterOwner" onchange="applyScheduleFilters()">
                            <option value="">All Owners</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.display_name }}</option>
                            {% endfor %}
                            <option value="unassigned">Unassigned</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" class="form-control form-control-sm" id="schFilterSearch"
                               placeholder="Search ref or title..." oninput="applyScheduleFilters()">
                    </div>
                    <div class="col-auto ms-auto">
                        <span class="badge bg-secondary" id="schRowCount">{{ schedule_rows|length }}</span>
                        <small class="text-muted">controls</small>
                    </div>
                </div>
            </div>

            <!-- Schedule Table -->
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width:36px;"><input type="checkbox" class="form-check-input" id="schSelectAll" onchange="toggleScheduleAll(this)"></th>
                            <th>Ref</th>
                            <th>Title</th>
                            <th>Domain</th>
                            <th>Criticality</th>
                            <th>Frequency</th>
                            <th>Last Tested</th>
                            <th>Next Due</th>
                            <th>Status</th>
                            <th>Owner</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                        {% for row in schedule_rows %}
                        <tr data-status="{{ row.testing_status }}"
                            data-domain="{{ row.impl.control.domain }}"
                            data-owner="{{ row.impl.owner_user_id or '' }}"
                            data-search="{{ row.impl.control.control_ref|lower }} {{ row.impl.control.title|lower }}"
                            data-criticality="{{ row.impl.control.criticality }}">
                            <td><input type="checkbox" class="form-check-input sch-checkbox" value="{{ row.impl.id }}" onchange="updateScheduleBulkBar()"></td>
                            <td>
                                <a href="/controls/{{ row.impl.control.id }}" class="text-decoration-none fw-semibold">
                                    {{ row.impl.control.control_ref }}
                                </a>
                            </td>
                            <td>{{ row.impl.control.title }}</td>
                            <td><small>{{ row.impl.control.domain }}</small></td>
                            <td>
                                <span class="badge bg-{% if row.impl.control.criticality == 'CRITICAL' %}danger{% elif row.impl.control.criticality == 'HIGH' %}warning text-dark{% elif row.impl.control.criticality == 'MEDIUM' %}info{% else %}secondary{% endif %}" style="font-size:0.65rem;">{{ row.impl.control.criticality }}</span>
                            </td>
                            <td><small>{{ frequency_labels.get(row.impl.control.test_frequency, row.impl.control.test_frequency) }}</small></td>
                            <td>
                                {% if row.last_tested %}
                                {{ row.last_tested.strftime('%Y-%m-%d') }}
                                {% else %}
                                <span class="text-muted">Never</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.impl.next_test_date %}
                                {{ row.impl.next_test_date.strftime('%Y-%m-%d') }}
                                {% else %}
                                <span class="text-muted">&mdash;</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.testing_status == 'OVERDUE' %}
                                <span class="status-badge status-overdue">Overdue {{ row.days_until_due|abs }}d</span>
                                {% elif row.testing_status == 'UPCOMING' %}
                                <span class="status-badge status-upcoming">Due in {{ row.days_until_due }}d</span>
                                {% elif row.testing_status == 'ON_TRACK' %}
                                <span class="status-badge status-on-track">On Track</span>
                                {% else %}
                                <span class="status-badge status-never">Never Tested</span>
                                {% endif %}
                                {% if scheduled_by_impl.get(row.impl.id) %}
                                <br><span class="status-badge status-scheduled mt-1">Scheduled: {{ scheduled_by_impl[row.impl.id][0].scheduled_date.strftime('%Y-%m-%d') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.impl.owner %}
                                <small>{{ row.impl.owner.display_name }}</small>
                                {% else %}
                                <span class="text-muted">&mdash;</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <div class="d-flex gap-1 justify-content-end">
                                    {% if scheduled_by_impl.get(row.impl.id) %}
                                    <form method="post" action="/controls/tests/{{ scheduled_by_impl[row.impl.id][0].id }}/start" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-primary" title="Start scheduled test">
                                            <i class="bi bi-play-circle"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    <form method="post" action="/controls/implementations/{{ row.impl.id }}/tests" class="d-inline">
                                        <input type="hidden" name="test_type" value="OPERATING">
                                        <button type="submit" class="btn btn-sm btn-outline-primary" title="New ad-hoc test">
                                            <i class="bi bi-plus-circle"></i>
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" title="Schedule Test"
                                            onclick="openScheduleModal('{{ row.impl.control.id }}')">
                                        <i class="bi bi-calendar-plus"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not schedule_rows %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-clipboard-check" style="font-size:2rem;"></i>
                    <p class="mt-2">No implemented controls with testing obligations yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ==================== IN PROGRESS TAB ==================== -->
    <div class="tab-pane fade" id="inProgressPane" role="tabpanel">
        <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
            <!-- In Progress Filters -->
            <div class="card-body py-2 border-bottom">
                <div class="row g-2 align-items-center tracker-filters">
                    <div class="col-auto">
                        <i class="bi bi-funnel me-1 text-muted"></i>
                        <strong class="small text-muted">Filters:</strong>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="ipFilterDomain" onchange="applyInProgressFilters()">
                            <option value="">All Domains</option>
                            {% for d in domains %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="ipFilterTester" onchange="applyInProgressFilters()">
                            <option value="">All Testers</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="ipFilterType" onchange="applyInProgressFilters()">
                            <option value="">All Types</option>
                            {% for key, label in test_type_labels.items() %}
                            <option value="{{ key }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" class="form-control form-control-sm" id="ipFilterSearch"
                               placeholder="Search ref or title..." oninput="applyInProgressFilters()">
                    </div>
                    <div class="col-auto ms-auto">
                        <span class="badge bg-secondary" id="ipRowCount">{{ in_progress_tests|length }}</span>
                        <small class="text-muted">tests</small>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Control Ref</th>
                            <th>Title</th>
                            <th>Domain</th>
                            <th>Type</th>
                            <th>Result</th>
                            <th>Tester</th>
                            <th>Evidence</th>
                            <th>Created</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inProgressBody">
                        {% for t in in_progress_tests %}
                        <tr data-domain="{{ t.implementation.control.domain if t.implementation and t.implementation.control else '' }}"
                            data-tester="{{ t.tester_user_id or '' }}"
                            data-type="{{ t.test_type }}"
                            data-search="{{ t.implementation.control.control_ref|lower if t.implementation and t.implementation.control else '' }} {{ t.implementation.control.title|lower if t.implementation and t.implementation.control else '' }}">
                            <td>
                                {% if t.implementation and t.implementation.control %}
                                <a href="/controls/{{ t.implementation.control.id }}" class="text-decoration-none fw-semibold">
                                    {{ t.implementation.control.control_ref }}
                                </a>
                                {% endif %}
                            </td>
                            <td>
                                {% if t.implementation and t.implementation.control %}
                                {{ t.implementation.control.title }}
                                {% endif %}
                            </td>
                            <td><small>{{ t.implementation.control.domain if t.implementation and t.implementation.control else '' }}</small></td>
                            <td><small>{{ test_type_labels.get(t.test_type, t.test_type) }}</small></td>
                            <td>
                                <span class="badge" style="background:{{ test_result_colors.get(t.result, '#6c757d') }};color:#fff;">
                                    {{ test_result_labels.get(t.result, t.result) }}
                                </span>
                            </td>
                            <td>
                                {% if t.tester %}
                                <small>{{ t.tester.display_name }}</small>
                                {% else %}
                                <span class="text-muted">&mdash;</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if t.evidence_files %}
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-paperclip"></i> {{ t.evidence_files|length }}
                                </span>
                                {% else %}
                                <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td><small>{{ t.created_at.strftime('%Y-%m-%d') if t.created_at else '&mdash;' }}</small></td>
                            <td class="text-end">
                                <a href="/controls/tests/{{ t.id }}" class="btn btn-sm btn-primary" title="Continue working">
                                    <i class="bi bi-pencil-square me-1"></i>Continue
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not in_progress_tests %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-pencil-square" style="font-size:2rem;"></i>
                    <p class="mt-2">No tests in progress. Start a scheduled test or create a new one.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ==================== HISTORY TAB ==================== -->
    <div class="tab-pane fade" id="historyPane" role="tabpanel">
        <div class="card" style="border-top-left-radius:0;border-top-right-radius:0;">
            <!-- History Filters -->
            <div class="card-body py-2 border-bottom">
                <div class="row g-2 align-items-center tracker-filters">
                    <div class="col-auto">
                        <i class="bi bi-funnel me-1 text-muted"></i>
                        <strong class="small text-muted">Filters:</strong>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="histFilterResult" onchange="applyHistoryFilters()">
                            <option value="">All Results</option>
                            {% for key, label in test_result_labels.items() %}
                            <option value="{{ key }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="histFilterType" onchange="applyHistoryFilters()">
                            <option value="">All Types</option>
                            {% for key, label in test_type_labels.items() %}
                            <option value="{{ key }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="histFilterDomain" onchange="applyHistoryFilters()">
                            <option value="">All Domains</option>
                            {% for d in domains %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="histFilterTester" onchange="applyHistoryFilters()">
                            <option value="">All Testers</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" class="form-control form-control-sm" id="histFilterSearch"
                               placeholder="Search ref or title..." oninput="applyHistoryFilters()">
                    </div>
                    <div class="col-auto ms-auto">
                        <span class="badge bg-secondary" id="histRowCount">{{ test_history|length }}</span>
                        <small class="text-muted">tests</small>
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Control Ref</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Result</th>
                            <th>Tester</th>
                            <th>Evidence</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        {% for t in test_history %}
                        <tr data-result="{{ t.result }}"
                            data-type="{{ t.test_type }}"
                            data-domain="{{ t.implementation.control.domain if t.implementation and t.implementation.control else '' }}"
                            data-tester="{{ t.tester_user_id or '' }}"
                            data-search="{{ t.implementation.control.control_ref|lower if t.implementation and t.implementation.control else '' }} {{ t.implementation.control.title|lower if t.implementation and t.implementation.control else '' }}">
                            <td>{{ t.test_date.strftime('%Y-%m-%d') if t.test_date else '&mdash;' }}</td>
                            <td>
                                {% if t.implementation and t.implementation.control %}
                                <a href="/controls/{{ t.implementation.control.id }}" class="text-decoration-none fw-semibold">
                                    {{ t.implementation.control.control_ref }}
                                </a>
                                {% else %}
                                <span class="text-muted">&mdash;</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if t.implementation and t.implementation.control %}
                                {{ t.implementation.control.title }}
                                {% endif %}
                            </td>
                            <td><small>{{ test_type_labels.get(t.test_type, t.test_type) }}</small></td>
                            <td>
                                <span class="badge" style="background:{{ test_result_colors.get(t.result, '#6c757d') }};color:#fff;">
                                    {{ test_result_labels.get(t.result, t.result) }}
                                </span>
                            </td>
                            <td>
                                {% if t.tester %}
                                <small>{{ t.tester.display_name }}</small>
                                {% else %}
                                <span class="text-muted">&mdash;</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if t.evidence_files %}
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-paperclip"></i> {{ t.evidence_files|length }}
                                </span>
                                {% else %}
                                <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <a href="/controls/tests/{{ t.id }}" class="btn btn-sm btn-outline-secondary" title="View test details">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not test_history %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-clock-history" style="font-size:2rem;"></i>
                    <p class="mt-2">No tests recorded yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ==================== SCHEDULE TEST MODAL ==================== -->
<div class="modal fade" id="scheduleTestModal" tabindex="-1" aria-labelledby="scheduleTestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/controls/testing/schedule">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleTestModalLabel"><i class="bi bi-calendar-plus me-2"></i>Schedule Test</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Control <span class="text-danger">*</span></label>
                        <select name="control_id" id="scheduleControlSelect" class="form-select" required>
                            <option value="">Select a control...</option>
                            {% for ctrl in all_controls %}
                            <option value="{{ ctrl.id }}">{{ ctrl.control_ref }} &mdash; {{ ctrl.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Scheduled Date <span class="text-danger">*</span></label>
                        <input type="date" name="scheduled_date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assigned Tester</label>
                        <select name="tester_user_id" class="form-select">
                            <option value="">-- Unassigned --</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Test Type <span class="text-danger">*</span></label>
                        <select name="test_type" class="form-select" required>
                            {% for t in test_types %}
                            <option value="{{ t }}">{{ test_type_labels[t] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-calendar-plus me-1"></i>Schedule</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function openScheduleModal(controlId) {
    var select = document.getElementById('scheduleControlSelect');
    if (select && controlId) {
        select.value = controlId;
    }
    var modal = new bootstrap.Modal(document.getElementById('scheduleTestModal'));
    modal.show();
}

function applyScheduleFilters() {
    var statusVal = document.getElementById('schFilterStatus').value;
    var domainVal = document.getElementById('schFilterDomain').value;
    var ownerVal = document.getElementById('schFilterOwner').value;
    var searchVal = document.getElementById('schFilterSearch').value.toLowerCase().trim();
    var rows = document.querySelectorAll('#scheduleBody tr');
    var visible = 0;

    rows.forEach(function(row) {
        var show = true;
        if (statusVal && row.dataset.status !== statusVal) show = false;
        if (domainVal && row.dataset.domain !== domainVal) show = false;
        if (ownerVal === 'unassigned' && row.dataset.owner !== '') show = false;
        else if (ownerVal && ownerVal !== 'unassigned' && row.dataset.owner !== ownerVal) show = false;
        if (searchVal && row.dataset.search.indexOf(searchVal) === -1) show = false;

        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    document.getElementById('schRowCount').textContent = visible;
}

function applyInProgressFilters() {
    var domainVal = document.getElementById('ipFilterDomain').value;
    var testerVal = document.getElementById('ipFilterTester').value;
    var typeVal = document.getElementById('ipFilterType').value;
    var searchVal = document.getElementById('ipFilterSearch').value.toLowerCase().trim();
    var rows = document.querySelectorAll('#inProgressBody tr');
    var visible = 0;

    rows.forEach(function(row) {
        var show = true;
        if (domainVal && row.dataset.domain !== domainVal) show = false;
        if (testerVal && row.dataset.tester !== testerVal) show = false;
        if (typeVal && row.dataset.type !== typeVal) show = false;
        if (searchVal && row.dataset.search.indexOf(searchVal) === -1) show = false;

        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    document.getElementById('ipRowCount').textContent = visible;
}

function applyHistoryFilters() {
    var resultVal = document.getElementById('histFilterResult').value;
    var typeVal = document.getElementById('histFilterType').value;
    var domainVal = document.getElementById('histFilterDomain').value;
    var testerVal = document.getElementById('histFilterTester').value;
    var searchVal = document.getElementById('histFilterSearch').value.toLowerCase().trim();
    var rows = document.querySelectorAll('#historyBody tr');
    var visible = 0;

    rows.forEach(function(row) {
        var show = true;
        if (resultVal && row.dataset.result !== resultVal) show = false;
        if (typeVal && row.dataset.type !== typeVal) show = false;
        if (domainVal && row.dataset.domain !== domainVal) show = false;
        if (testerVal && row.dataset.tester !== testerVal) show = false;
        if (searchVal && row.dataset.search.indexOf(searchVal) === -1) show = false;

        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    document.getElementById('histRowCount').textContent = visible;
}

// Bulk schedule selection
function updateScheduleBulkBar() {
    var checked = document.querySelectorAll('.sch-checkbox:checked');
    var bar = document.getElementById('bulkScheduleBar');
    var count = document.getElementById('schSelectedCount');
    if (checked.length > 0) {
        bar.style.display = '';
        count.textContent = checked.length;
        var form = document.getElementById('bulkScheduleForm');
        form.querySelectorAll('input[name="impl_ids"]').forEach(function(el) { el.remove(); });
        checked.forEach(function(cb) {
            var inp = document.createElement('input');
            inp.type = 'hidden';
            inp.name = 'impl_ids';
            inp.value = cb.value;
            form.appendChild(inp);
        });
    } else {
        bar.style.display = 'none';
    }
}

function toggleScheduleAll(el) {
    document.querySelectorAll('.sch-checkbox').forEach(function(cb) {
        var row = cb.closest('tr');
        if (row.style.display !== 'none') cb.checked = el.checked;
    });
    updateScheduleBulkBar();
}

function clearScheduleSelection() {
    document.querySelectorAll('.sch-checkbox').forEach(function(cb) { cb.checked = false; });
    document.getElementById('schSelectAll').checked = false;
    updateScheduleBulkBar();
}

// URL param handling
(function() {
    var params = new URLSearchParams(window.location.search);

    var tabParam = params.get('tab');
    if (tabParam === 'history') {
        var histTab = document.getElementById('history-tab');
        if (histTab) { new bootstrap.Tab(histTab).show(); }
    } else if (tabParam === 'in-progress') {
        var ipTab = document.getElementById('inprogress-tab');
        if (ipTab) { new bootstrap.Tab(ipTab).show(); }
    }

    if (params.get('status')) {
        document.getElementById('schFilterStatus').value = params.get('status');
        applyScheduleFilters();
    }

    if (params.get('result')) {
        document.getElementById('histFilterResult').value = params.get('result');
        applyHistoryFilters();
    }

    if (params.get('schedule')) {
        setTimeout(function() { openScheduleModal(params.get('schedule')); }, 300);
    }
})();
</script>
{% endblock %}
